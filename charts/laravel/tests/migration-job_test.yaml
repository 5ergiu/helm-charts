suite: test migration job
templates:
  - migration-job.yaml
tests:
  - it: should create migration job by default
    asserts:
      - isKind:
          of: Job
      - matchRegex:
          path: metadata.name
          pattern: ^RELEASE-NAME-laravel-migration-\d+$
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: "pre-install,pre-upgrade"
      - equal:
          path: spec.template.spec.containers[0].command
          value: ["php", "artisan", "migrate", "--force"]

  - it: should disable migrations
    set:
      migration.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should have hook-delete-policy
    asserts:
      - equal:
          path: metadata.annotations["helm.sh/hook-delete-policy"]
          value: "before-hook-creation"

  - it: should have security context with default values
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 82

  - it: should use custom user ID when specified
    set:
      migration.podSecurityContext.runAsUser: 501
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 501

  - it: should use readOnlyRootFilesystem
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: tmp
            emptyDir:
              medium: Memory
