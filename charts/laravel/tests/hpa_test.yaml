suite: test hpa
templates:
  - hpa.yaml
tests:
  - it: should not create HPA when all disabled
    set:
      web.autoscaling.enabled: false
      workers.default.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create HPA for web when enabled
    set:
      web.autoscaling.enabled: true
      workers.default.enabled: false
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: metadata.name
          value: RELEASE-NAME-laravel-web
      - equal:
          path: spec.scaleTargetRef.name
          value: RELEASE-NAME-laravel-web
      - equal:
          path: spec.minReplicas
          value: 2
      - equal:
          path: spec.maxReplicas
          value: 10

  - it: should create HPA for both web and default worker
    set:
      web.autoscaling.enabled: true
      workers.default.enabled: true
      workers.default.autoscaling.enabled: true
      workers.default.autoscaling.minReplicas: 2
      workers.default.autoscaling.maxReplicas: 10
    asserts:
      - hasDocuments:
          count: 2

  - it: should set custom min and max replicas for web
    set:
      web.autoscaling.enabled: true
      web.autoscaling.minReplicas: 3
      web.autoscaling.maxReplicas: 20
      workers.default.enabled: false
    asserts:
      - equal:
          path: spec.minReplicas
          value: 3
      - equal:
          path: spec.maxReplicas
          value: 20

  - it: should configure CPU target for web
    set:
      web.autoscaling.enabled: true
      web.autoscaling.targetCPUUtilizationPercentage: 70
      workers.default.enabled: false
    asserts:
      - contains:
          path: spec.metrics
          content:
            type: Resource
            resource:
              name: cpu
              target:
                type: Utilization
                averageUtilization: 70

  - it: should configure memory target for web
    set:
      web.autoscaling.enabled: true
      web.autoscaling.targetMemoryUtilizationPercentage: 80
      workers.default.enabled: false
    asserts:
      - contains:
          path: spec.metrics
          content:
            type: Resource
            resource:
              name: memory
              target:
                type: Utilization
                averageUtilization: 80

  - it: should create HPA for horizon worker when enabled
    set:
      web.autoscaling.enabled: false
      workers.default.enabled: false
      workers.horizon.enabled: true
      workers.horizon.autoscaling.enabled: true
      workers.horizon.autoscaling.minReplicas: 2
      workers.horizon.autoscaling.maxReplicas: 10
      workers.horizon.image.repository: ghcr.io/5ergiu/images/laravel
      workers.horizon.image.tag: cli
      workers.horizon.args: ["php", "artisan", "horizon"]
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: metadata.name
          value: RELEASE-NAME-laravel-worker-horizon
      - equal:
          path: spec.scaleTargetRef.name
          value: RELEASE-NAME-laravel-worker-horizon
      - equal:
          path: spec.minReplicas
          value: 2
      - equal:
          path: spec.maxReplicas
          value: 10

  - it: should create HPA for default worker when enabled
    set:
      web.autoscaling.enabled: false
      workers.default.enabled: true
      workers.default.autoscaling.enabled: true
      workers.default.autoscaling.minReplicas: 2
      workers.default.autoscaling.maxReplicas: 10
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: metadata.name
          value: RELEASE-NAME-laravel-worker-default
      - equal:
          path: spec.scaleTargetRef.name
          value: RELEASE-NAME-laravel-worker-default

  - it: should create HPA for all components when enabled
    set:
      web.autoscaling.enabled: true
      workers.default.enabled: true
      workers.default.autoscaling.enabled: true
      workers.default.autoscaling.minReplicas: 2
      workers.default.autoscaling.maxReplicas: 10
      workers.horizon.enabled: true
      workers.horizon.autoscaling.enabled: true
      workers.horizon.autoscaling.minReplicas: 2
      workers.horizon.autoscaling.maxReplicas: 10
      workers.horizon.image.repository: ghcr.io/5ergiu/images/laravel
      workers.horizon.image.tag: cli
      workers.horizon.args: ["php", "artisan", "horizon"]
    asserts:
      - hasDocuments:
          count: 3

  - it: should configure horizon HPA with custom settings
    set:
      web.autoscaling.enabled: false
      workers.default.enabled: false
      workers.horizon.enabled: true
      workers.horizon.autoscaling.enabled: true
      workers.horizon.autoscaling.minReplicas: 3
      workers.horizon.autoscaling.maxReplicas: 15
      workers.horizon.autoscaling.targetCPUUtilizationPercentage: 75
      workers.horizon.autoscaling.targetMemoryUtilizationPercentage: 85
      workers.horizon.image.repository: ghcr.io/5ergiu/images/laravel
      workers.horizon.image.tag: cli
      workers.horizon.args: ["php", "artisan", "horizon"]
    asserts:
      - equal:
          path: spec.minReplicas
          value: 3
      - equal:
          path: spec.maxReplicas
          value: 15
      - contains:
          path: spec.metrics
          content:
            type: Resource
            resource:
              name: cpu
              target:
                type: Utilization
                averageUtilization: 75
      - contains:
          path: spec.metrics
          content:
            type: Resource
            resource:
              name: memory
              target:
                type: Utilization
                averageUtilization: 85
