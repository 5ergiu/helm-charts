suite: test hpa
templates:
  - hpa.yaml
tests:
  - it: should not create HPA when all disabled
    set:
      web.autoscaling.enabled: false
      worker.autoscaling.enabled: false
      horizon.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create HPA for web when enabled
    set:
      web.autoscaling.enabled: true
      worker.autoscaling.enabled: false
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: metadata.name
          value: RELEASE-NAME-laravel-web
      - equal:
          path: spec.scaleTargetRef.name
          value: RELEASE-NAME-laravel-web
      - equal:
          path: spec.minReplicas
          value: 2
      - equal:
          path: spec.maxReplicas
          value: 10

  - it: should create HPA for both web and worker
    set:
      web.autoscaling.enabled: true
      worker.autoscaling.enabled: true
    asserts:
      - hasDocuments:
          count: 2

  - it: should set custom min and max replicas for web
    set:
      web.autoscaling.enabled: true
      web.autoscaling.minReplicas: 3
      web.autoscaling.maxReplicas: 20
      worker.autoscaling.enabled: false
    asserts:
      - equal:
          path: spec.minReplicas
          value: 3
      - equal:
          path: spec.maxReplicas
          value: 20

  - it: should configure CPU target for web
    set:
      web.autoscaling.enabled: true
      web.autoscaling.targetCPUUtilizationPercentage: 70
      worker.autoscaling.enabled: false
    asserts:
      - contains:
          path: spec.metrics
          content:
            type: Resource
            resource:
              name: cpu
              target:
                type: Utilization
                averageUtilization: 70

  - it: should configure memory target for web
    set:
      web.autoscaling.enabled: true
      web.autoscaling.targetMemoryUtilizationPercentage: 80
      worker.autoscaling.enabled: false
    asserts:
      - contains:
          path: spec.metrics
          content:
            type: Resource
            resource:
              name: memory
              target:
                type: Utilization
                averageUtilization: 80

  - it: should create HPA for horizon when enabled
    set:
      web.autoscaling.enabled: false
      worker.autoscaling.enabled: false
      horizon.enabled: true
      horizon.autoscaling.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: metadata.name
          value: RELEASE-NAME-laravel-horizon
      - equal:
          path: spec.scaleTargetRef.name
          value: RELEASE-NAME-laravel-horizon
      - equal:
          path: spec.minReplicas
          value: 2
      - equal:
          path: spec.maxReplicas
          value: 10

  - it: should create HPA for all components when enabled
    set:
      web.autoscaling.enabled: true
      worker.autoscaling.enabled: true
      horizon.enabled: true
      horizon.autoscaling.enabled: true
    asserts:
      - hasDocuments:
          count: 3

  - it: should configure horizon HPA with custom settings
    set:
      web.autoscaling.enabled: false
      worker.autoscaling.enabled: false
      horizon.enabled: true
      horizon.autoscaling.enabled: true
      horizon.autoscaling.minReplicas: 3
      horizon.autoscaling.maxReplicas: 15
      horizon.autoscaling.targetCPUUtilizationPercentage: 75
      horizon.autoscaling.targetMemoryUtilizationPercentage: 85
    asserts:
      - equal:
          path: spec.minReplicas
          value: 3
      - equal:
          path: spec.maxReplicas
          value: 15
      - contains:
          path: spec.metrics
          content:
            type: Resource
            resource:
              name: cpu
              target:
                type: Utilization
                averageUtilization: 75
      - contains:
          path: spec.metrics
          content:
            type: Resource
            resource:
              name: memory
              target:
                type: Utilization
                averageUtilization: 85
