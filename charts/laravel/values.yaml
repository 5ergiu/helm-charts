# ============================================================================
# Default Values for Laravel Helm Chart
# ============================================================================
# Production-ready secure defaults for Laravel applications supporting multiple
# runtime configurations:
#   - PHP-FPM with Nginx/Apache/Caddy reverse proxy
#   - FrankenPHP standalone server
#   - Laravel Octane (RoadRunner/Swoole/FrankenPHP)
#   - CLI-only workers and cron jobs
#
# Key Features:
# - High availability with autoscaling
# - PostgreSQL/MySQL database support
# - Redis caching and queue support
# - Security hardened (read-only filesystem, non-root user)
# - Traefik ingress with TLS support
# - Multiple deployment variants (ALL DISABLED by default)
#
# For different deployment scenarios, see the examples directory:
#   - examples/laravel/values.ci.yaml    - CI/CD optimized (zero dependencies)
#   - examples/laravel/values.test.yaml  - Local testing (SQLite + file drivers)
#   - examples/laravel/values.local.yaml - Development with hot reload (Bun sidecar)
#   - examples/laravel/values.prod.yaml  - Production overrides (Horizon, higher resources)
#
# Chart Documentation: https://github.com/5ergiu/helm-charts/tree/main/charts/laravel
# ============================================================================

# ============================================================================
# Global Settings
# ============================================================================

global:
  environment: production

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# ============================================================================
# ServiceAccount Configuration
# ============================================================================

serviceAccount:
  create: true
  annotations: {}
  name: ""

# ============================================================================
# Global PHP Configuration (ConfigMaps - used by all deployments)
# ============================================================================
# These configuration files are created as ConfigMaps and can be mounted
# into any deployment that needs them. Individual deployments enable them
# via their php.engine settings.

php:
  # ============================================================================
  # PHP.ini Configuration (ALL engines)
  # ============================================================================
  # Standard PHP configuration using php.ini format
  # Mounted as ConfigMap to /usr/local/etc/php/conf.d/zz-custom.ini
  # Works with any PHP image (official, ServersideUp, custom, etc.)

  ini:
    enabled: true

    # Mount path (customize for non-standard images)
    mountPath: /usr/local/etc/php/conf.d/zz-custom.ini

    # php.ini settings (key-value pairs)
    # These are converted to standard php.ini format: key = value
    config:
      # ========================================================================
      # Core Settings
      # ========================================================================
      engine: "On"
      short_open_tag: "Off"
      precision: "14"
      output_buffering: "4096"
      expose_php: "Off"

      # ========================================================================
      # Resource Limits
      # ========================================================================
      max_execution_time: "99"        # Maximum execution time (seconds)
      max_input_time: "-1"            # Maximum input parsing time (-1 = unlimited)
      max_input_vars: "1000"          # Maximum input variables
      memory_limit: "256M"            # Memory limit per script

      # ========================================================================
      # Error Handling (Production defaults)
      # ========================================================================
      # For development: set display_errors=On, error_reporting=E_ALL
      display_errors: "Off"                  # Never show errors in production
      display_startup_errors: "Off"          # Hide startup errors
      error_reporting: "22527"               # E_ALL & ~E_DEPRECATED & ~E_STRICT
      log_errors: "On"                       # Always log errors
      error_log: "/dev/stderr"               # Send errors to container logs

      # ========================================================================
      # Data Handling
      # ========================================================================
      variables_order: "GPCS"                # GET, POST, COOKIE, SERVER
      request_order: "GP"                    # GET, POST (no COOKIE in request)
      post_max_size: "100M"                  # Maximum POST data size
      default_charset: "UTF-8"               # Default character encoding

      # ========================================================================
      # File Uploads
      # ========================================================================
      file_uploads: "On"                     # Enable file uploads
      upload_max_filesize: "100M"            # Maximum upload file size
      max_file_uploads: "20"                 # Maximum number of files per upload

      # ========================================================================
      # Security
      # ========================================================================
      open_basedir: ""                       # Restrict file access (empty = no restriction)
      allow_url_fopen: "On"                  # Allow opening URLs as files
      allow_url_include: "Off"               # Disable including URLs (security)

      # ========================================================================
      # Performance
      # ========================================================================
      realpath_cache_size: "4096K"           # Realpath cache size
      realpath_cache_ttl: "120"              # Realpath cache TTL (seconds)

      # ========================================================================
      # Date/Time
      # ========================================================================
      "date.timezone": "UTC"                 # Default timezone

      # ========================================================================
      # Session
      # ========================================================================
      # For production with Redis sessions, these are often overridden by Laravel
      "session.save_handler": "files"        # Session handler (files, redis, etc.)
      "session.use_strict_mode": "1"         # Use strict session IDs
      "session.cookie_secure": "1"           # Only send cookies over HTTPS
      "session.cookie_httponly": "1"         # Prevent JavaScript access to cookies
      "session.cookie_samesite": "Lax"       # CSRF protection

      # ========================================================================
      # OPcache (Critical for production performance)
      # ========================================================================
      # Production: enable=1, validate_timestamps=0 (no file checks)
      # Development: enable=1, validate_timestamps=1 (detect file changes)
      "opcache.enable": "1"                         # Enable OPcache
      "opcache.enable_cli": "0"                     # Disable OPcache for CLI
      "opcache.memory_consumption": "128"           # OPcache memory (MB)
      "opcache.interned_strings_buffer": "8"        # Interned strings memory (MB)
      "opcache.max_accelerated_files": "10000"      # Maximum cached files
      "opcache.validate_timestamps": "0"            # 0=prod (no checks), 1=dev (check files)
      "opcache.revalidate_freq": "2"                # Check frequency (seconds, if validate_timestamps=1)
      "opcache.save_comments": "1"                  # Required for Laravel annotations
      "opcache.jit": "off"                          # JIT compilation (off, function, tracing)
      "opcache.jit_buffer_size": "0"                # JIT buffer size (MB, 0=disabled)

  # ============================================================================
  # PHP-FPM Configuration
  # ============================================================================
  # Only used when php.engine: fpm
  # Mounted as ConfigMap to /usr/local/etc/php-fpm.d/zz-custom.conf

  fpm:
    enabled: false  # Auto-enabled when php.engine: fpm

    # Mount path (customize for non-standard images)
    mountPath: /usr/local/etc/php-fpm.d/zz-custom.conf

    # php-fpm.conf pool settings (key-value pairs)
    # These are converted to standard php-fpm.conf format: key = value
    config:
      # ========================================================================
      # Pool Configuration
      # ========================================================================
      listen: "127.0.0.1:9000"                      # Listen on localhost:9000
      pm: "dynamic"                                 # Process manager (static, dynamic, ondemand)

      # Dynamic PM settings (when pm: dynamic)
      "pm.max_children": "20"                       # Maximum child processes
      "pm.start_servers": "2"                       # Initial child processes
      "pm.min_spare_servers": "1"                   # Minimum idle processes
      "pm.max_spare_servers": "3"                   # Maximum idle processes
      "pm.max_requests": "0"                        # Requests before respawn (0=unlimited)
      "pm.process_idle_timeout": "10s"              # Idle timeout before process termination

      # ========================================================================
      # Process Control
      # ========================================================================
      process_control_timeout: "10"                 # Graceful stop timeout (seconds)
      request_terminate_timeout: "0"                # Request timeout (0=unlimited)

      # ========================================================================
      # Logging
      # ========================================================================
      "access.log": "/dev/null"                     # Disable access logs (use nginx logs)
      catch_workers_output: "yes"                   # Capture worker stdout/stderr
      decorate_workers_output: "no"                 # Don't add timestamps to output

      # ========================================================================
      # Security
      # ========================================================================
      "security.limit_extensions": ".php"           # Only allow .php files

  # ============================================================================
  # FrankenPHP Configuration
  # ============================================================================
  # Only used when php.engine: frankenphp
  # Mounted as ConfigMap to /etc/caddy/Caddyfile

  frankenphp:
    enabled: false  # Auto-enabled when php.engine: frankenphp

    # Mount path for Caddyfile
    mountPath: /etc/caddy/Caddyfile

    # Caddyfile content (standard Caddy format)
    # This is the complete Caddyfile configuration for FrankenPHP
    caddyfile: |
      {
          # Global options
          auto_https off
          admin off
          frankenphp
      }

      :8080 {
          # Root directory
          root * /var/www/html/public

          # Enable FrankenPHP
          php_server

          # Logging
          log {
              output stderr
              format console
              level warn
          }

          # Error handling
          handle_errors {
              respond "{err.status_code} {err.status_text}"
          }

          # Security headers
          header {
              X-Frame-Options "SAMEORIGIN"
              X-Content-Type-Options "nosniff"
              X-XSS-Protection "1; mode=block"
              -Server
              -X-Powered-By
          }

          # Compression
          encode gzip zstd

          # File server for static assets
          file_server
      }

    # Server configuration
    server:
      port: 8080  # FrankenPHP listen port

  # ============================================================================
  # Laravel Octane Configuration
  # ============================================================================
  # Only used when php.engine: roadrunner or swoole
  # Mounted as ConfigMap to /var/www/html/.octane.php

  octane:
    enabled: false  # Auto-enabled when php.engine: roadrunner or swoole

    # Octane server type (roadrunner, swoole)
    server: "roadrunner"

    # Mount path for .octane.php config
    mountPath: /var/www/html/.octane.php

    # .octane.php configuration file content
    # This is the complete Octane configuration
    config: |
      <?php

      use Laravel\Octane\Events\RequestHandled;
      use Laravel\Octane\Events\RequestReceived;
      use Laravel\Octane\Events\RequestTerminated;
      use Laravel\Octane\Events\TaskReceived;
      use Laravel\Octane\Events\TaskTerminated;
      use Laravel\Octane\Events\TickReceived;
      use Laravel\Octane\Events\TickTerminated;
      use Laravel\Octane\Events\OperationTerminated;
      use Laravel\Octane\Events\WorkerErrorOccurred;
      use Laravel\Octane\Events\WorkerStarting;
      use Laravel\Octane\Events\WorkerStopping;
      use Laravel\Octane\Listeners\EnsureUploadedFilesAreValid;
      use Laravel\Octane\Listeners\EnsureUploadedFilesCanBeMoved;
      use Laravel\Octane\Listeners\FlushTemporaryContainerInstances;
      use Laravel\Octane\Listeners\FlushSessionState;
      use Laravel\Octane\Listeners\ReportException;
      use Laravel\Octane\Listeners\StopWorkerIfNecessary;

      return [
          /*
          |--------------------------------------------------------------------------
          | Octane Server
          |--------------------------------------------------------------------------
          |
          | This value determines the default "server" that will be used by Octane
          | when starting, reloading, or stopping your server via the CLI. You
          | are free to change this to the supported server of your choice.
          |
          */

          'server' => env('OCTANE_SERVER', 'roadrunner'),

          /*
          |--------------------------------------------------------------------------
          | Force HTTPS
          |--------------------------------------------------------------------------
          |
          | When this configuration value is set to "true", Octane will inform the
          | framework that all absolute links should be generated using "https"
          | protocol instead of "http". Typically this should be enabled for
          | production deployments behind a load balancer with SSL termination.
          |
          */

          'https' => env('OCTANE_HTTPS', false),

          /*
          |--------------------------------------------------------------------------
          | Octane Listeners
          |--------------------------------------------------------------------------
          |
          | All of the event listeners for Octane's events are defined below. These
          | listeners can reset server state between requests, clear caches, etc.
          |
          */

          'listeners' => [
              WorkerStarting::class => [
                  EnsureUploadedFilesAreValid::class,
                  EnsureUploadedFilesCanBeMoved::class,
              ],

              RequestReceived::class => [
                  ...Octane::prepareApplicationForNextOperation(),
                  ...Octane::prepareApplicationForNextRequest(),
              ],

              RequestHandled::class => [],

              RequestTerminated::class => [
                  FlushTemporaryContainerInstances::class,
              ],

              TaskReceived::class => [
                  ...Octane::prepareApplicationForNextOperation(),
              ],

              TaskTerminated::class => [
                  FlushTemporaryContainerInstances::class,
              ],

              TickReceived::class => [
                  ...Octane::prepareApplicationForNextOperation(),
              ],

              TickTerminated::class => [
                  FlushTemporaryContainerInstances::class,
              ],

              OperationTerminated::class => [
                  FlushSessionState::class,
              ],

              WorkerErrorOccurred::class => [
                  ReportException::class,
                  StopWorkerIfNecessary::class,
              ],

              WorkerStopping::class => [],
          ],

          /*
          |--------------------------------------------------------------------------
          | Warm / Flush Bindings
          |--------------------------------------------------------------------------
          |
          | Here you can configure which bindings should be warmed / flushed.
          |
          */

          'warm' => [
              ...Octane::defaultServicesToWarm(),
          ],

          'flush' => [],

          /*
          |--------------------------------------------------------------------------
          | Octane Cache Table
          |--------------------------------------------------------------------------
          |
          | The cache table configuration for Octane's cache driver.
          |
          */

          'cache' => [
              'rows' => 1000,
          ],

          /*
          |--------------------------------------------------------------------------
          | Octane Swoole Tables
          |--------------------------------------------------------------------------
          |
          | Tables for Swoole-specific features.
          |
          */

          'tables' => [
              'example:1000' => [
                  'name' => 'string:1000',
                  'votes' => 'int',
              ],
          ],
      ];

    # Server configuration (used by Octane startup command)
    serverConfig:
      port: 8000                    # Octane default port
      host: "0.0.0.0"               # Listen on all interfaces
      workers: 4                    # Number of worker processes
      maxRequests: 500              # Requests before worker restart

      # RoadRunner specific configuration
      roadrunner:
        http:
          address: "0.0.0.0:8000"
          maxRequestSize: 100       # MB
          middleware: ["gzip"]
          pool:
            numWorkers: 4
            maxJobs: 64
            allocateTimeout: 60s
            destroyTimeout: 60s

      # Swoole specific configuration
      swoole:
        options:
          logLevel: 2
          packageMaxLength: 10485760  # 10MB

# ============================================================================
# HTTP Sidecar Configuration (ConfigMaps - used by web deployment when enabled)
# ============================================================================
# These configurations are used when the web deployment needs an HTTP sidecar
# (nginx, apache, or caddy) to proxy requests to PHP-FPM

http:
  # Nginx configuration (when web.http.entrypoint: nginx)
  nginx:
    image:
      repository: nginx
      tag: 1.29.4-alpine
      pullPolicy: IfNotPresent

    # Server configuration
    port: 8080
    root: /var/www/html/public

    # Logging
    accessLog: "off"
    errorLog: /dev/stderr
    errorLevel: warn

    # Security
    serverTokens: "off"

    # Performance & limits
    clientMaxBodySize: 100M
    keepaliveTimeout: 65

    # FastCGI settings
    fastcgiBuffers: 8 8k
    fastcgiBufferSize: 8k
    fastcgiReadTimeout: 120s

    # Resources
    resources:
      limits:
        cpu: 500m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

  # Apache configuration (when web.http.entrypoint: apache)
  apache:
    image:
      repository: httpd
      tag: 2.4-alpine
      pullPolicy: IfNotPresent

    # Server configuration
    port: 8080
    root: /var/www/html/public

    # Logging
    accessLog: /dev/stdout
    errorLog: /dev/stderr
    logLevel: warn

    # Security
    serverTokens: Prod
    serverSignature: "Off"

    # Performance & limits
    maxRequestWorkers: 150
    keepAliveTimeout: 5
    maxKeepAliveRequests: 100
    limitRequestBody: 104857600  # 100MB in bytes

    # FastCGI settings
    fcgiConnectTimeout: 120

    # Resources
    resources:
      limits:
        cpu: 500m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

  # Caddy configuration (when web.http.entrypoint: caddy)
  caddy:
    image:
      repository: caddy
      tag: 2-alpine
      pullPolicy: IfNotPresent

    # Server configuration
    port: 8080
    root: /var/www/html/public

    # Logging
    accessLog: false

    # Performance & limits
    maxBodySize: 100MB

    # Resources
    resources:
      limits:
        cpu: 500m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 64Mi

# ============================================================================
# Web Deployment Configuration
# ============================================================================
# Single web deployment - user chooses http entrypoint and php engine
# DISABLED by default - users must explicitly enable and configure
#
# HTTP Entrypoint Options:
#   - nginx: Nginx reverse proxy sidecar (for FPM, connects to port 9000)
#   - apache: Apache reverse proxy sidecar (for FPM, connects to port 9000)
#   - caddy: Caddy reverse proxy sidecar (for FPM, connects to port 9000)
#   - frankenphp: FrankenPHP standalone server (built-in Caddy + PHP)
#   - none: No HTTP server (for when Octane serves HTTP)
#
# PHP Engine Options:
#   - fpm: PHP-FPM (requires HTTP entrypoint: nginx/apache/caddy)
#   - frankenphp: FrankenPHP (requires entrypoint: frankenphp)
#   - roadrunner: RoadRunner (requires entrypoint: none)
#   - swoole: Swoole (requires entrypoint: none)
#   - cli: PHP CLI only (requires entrypoint: none)

web:
  enabled: false  # Set to true to enable web deployment
  replicaCount: 2

  # HTTP entrypoint configuration
  http:
    entrypoint: ""  # nginx, apache, caddy, frankenphp, none

  # PHP engine configuration
  php:
    engine: ""  # fpm, frankenphp, roadrunner, swoole, cli

  # Container image
  image:
    repository: ""
    tag: ""
    pullPolicy: IfNotPresent

  # Init containers for web deployment
  # Run before the main container starts (e.g., cache warmup, asset compilation)
  initContainers: []

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"

  podLabels: {}

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 82   # Alpine www-data user (change to match your image)
    fsGroup: 82     # Alpine www-data group (change to match your image)
    seccompProfile:
      type: RuntimeDefault

  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true

  # Ports configuration - adjust based on your http.entrypoint and php.engine:
  # - FPM: port 9000
  # - FrankenPHP: port 8080
  # - Octane (RoadRunner/Swoole): port 8000
  ports:
    - name: http
      containerPort: 8080
      protocol: TCP

  service:
    type: ClusterIP
    port: 80
    targetPort: 8080
    annotations: {}

  resources:
    limits:
      cpu: 1000m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi

  livenessProbe:
    enabled: true
    httpGet:
      path: /healthcheck
      port: 8080
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3

  readinessProbe:
    enabled: true
    httpGet:
      path: /healthcheck
      port: 8080
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    successThreshold: 1
    failureThreshold: 3

  startupProbe:
    enabled: true
    httpGet:
      path: /healthcheck
      port: 8080
    initialDelaySeconds: 0
    periodSeconds: 5
    timeoutSeconds: 3
    successThreshold: 1
    failureThreshold: 30

  # Autoscaling configuration
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
        - type: Percent
          value: 50
          periodSeconds: 60
      scaleUp:
        stabilizationWindowSeconds: 0
        policies:
        - type: Percent
          value: 100
          periodSeconds: 15
        - type: Pods
          value: 2
          periodSeconds: 15
        selectPolicy: Max

  # Pod Disruption Budget
  pdb:
    enabled: true
    minAvailable: 1

  # Additional sidecars (HTTP sidecars are auto-injected based on http.entrypoint)
  sidecars: []

  # Per-deployment environment variables (in addition to global laravel.env)
  env: []

  # Per-deployment environment variables from ConfigMaps/Secrets
  envFrom: []

  # Per-deployment volumes (in addition to tmpfs and persistence volumes)
  volumes: []

  # Per-deployment volume mounts
  volumeMounts: []

  nodeSelector: {}
  tolerations: []
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
              - laravel
            - key: app.kubernetes.io/component
              operator: In
              values:
              - web
          topologyKey: kubernetes.io/hostname

# ============================================================================
# Workers Configuration
# ============================================================================
# Laravel queue workers - ALL DISABLED by default, enable as needed
# Multiple worker variants supporting different runtime combinations
#
# Available variants:
#   1. default                    - CLI worker (queue:work)
#   2. horizon                    - CLI worker (Horizon)
#   3. octane-roadrunner-worker   - Octane RoadRunner worker (high-performance)
#   4. octane-swoole-worker       - Octane Swoole worker (high-performance)
#   5. emails                     - CLI worker (dedicated email queue)

workers:
  # ============================================================================
  # Example 1: Default Queue Worker (CLI)
  # ============================================================================
  # Runtime: http.entrypoint=none, php.engine=cli
  # Image: Official PHP CLI image
  # Command: php artisan queue:work

  default:
    enabled: false
    replicaCount: 2

    http:
      entrypoint: "none"
    php:
      engine: "cli"

    image:
      repository: php
      tag: "8.3-cli"
      pullPolicy: IfNotPresent

    strategy:
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 1
        maxUnavailable: 0

    podAnnotations: {}
    podLabels: {}

    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 82
      fsGroup: 82
      seccompProfile:
        type: RuntimeDefault

    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      readOnlyRootFilesystem: true

    # Worker command - Basic queue worker
    args:
      - "php"
      - "artisan"
      - "queue:work"
      - "--verbose"
      - "--tries=3"
      - "--max-time=3600"
      - "--sleep=3"
      - "--timeout=300"

    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi

    # Liveness probe for basic queue worker
    livenessProbe:
      enabled: true
      exec:
        command: ["healthcheck-queue"]
      initialDelaySeconds: 30
      periodSeconds: 60
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 3

    # Autoscaling configuration
    autoscaling:
      enabled: true
      minReplicas: 2
      maxReplicas: 10
      targetCPUUtilizationPercentage: 70
      targetMemoryUtilizationPercentage: 80

    # Pod Disruption Budget
    pdb:
      enabled: true
      minAvailable: 1

    sidecars: []
    env: []
    envFrom: []
    volumes: []
    volumeMounts: []
    initContainers: []

    nodeSelector: {}
    tolerations: []
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                - laravel
              - key: app.kubernetes.io/component
                operator: In
                values:
                - worker-default
            topologyKey: kubernetes.io/hostname

  # ============================================================================
  # Example 2: Laravel Horizon Worker (CLI)
  # ============================================================================
  # Runtime: http.entrypoint=none, php.engine=cli
  # Image: Official PHP CLI image
  # Command: php artisan horizon

  horizon:
    enabled: false
    replicaCount: 1

    http:
      entrypoint: "none"
    php:
      engine: "cli"

    image:
      repository: php
      tag: "8.3-cli"
      pullPolicy: IfNotPresent

    strategy:
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 1
        maxUnavailable: 0

    podAnnotations: {}
    podLabels: {}

    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 82
      fsGroup: 82
      seccompProfile:
        type: RuntimeDefault

    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      readOnlyRootFilesystem: true

    # Horizon command
    args: ["php", "artisan", "horizon"]

    resources:
      limits:
        cpu: 1000m
        memory: 1Gi
      requests:
        cpu: 250m
        memory: 512Mi

    # Horizon health check
    livenessProbe:
      enabled: true
      exec:
        command: ["healthcheck-horizon"]
      initialDelaySeconds: 30
      periodSeconds: 60
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 3

    # Autoscaling (typically Horizon runs as 1 instance)
    autoscaling:
      enabled: false
      minReplicas: 1
      maxReplicas: 3
      targetCPUUtilizationPercentage: 70
      targetMemoryUtilizationPercentage: 80

    pdb:
      enabled: true
      minAvailable: 1

    sidecars: []
    env: []
    envFrom: []
    volumes: []
    volumeMounts: []
    initContainers: []

    nodeSelector: {}
    tolerations: []
    affinity: {}

  # ============================================================================
  # Example 3: Octane RoadRunner Worker (High-Performance)
  # ============================================================================
  # Runtime: http.entrypoint=none, php.engine=roadrunner
  # Image: Custom Laravel Octane image with RoadRunner
  # Command: php artisan queue:work
  # Use case: CPU-intensive background tasks that benefit from persistent memory

  octane-roadrunner-worker:
    enabled: false
    replicaCount: 1

    http:
      entrypoint: "none"
    php:
      engine: "roadrunner"

    image:
      repository: your-custom/laravel-octane
      tag: "roadrunner-latest"
      pullPolicy: IfNotPresent

    strategy:
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 1
        maxUnavailable: 0

    podAnnotations: {}
    podLabels: {}

    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 82
      fsGroup: 82
      seccompProfile:
        type: RuntimeDefault

    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      readOnlyRootFilesystem: true

    args:
      - "php"
      - "artisan"
      - "queue:work"

    resources:
      limits:
        cpu: 1000m
        memory: 1Gi
      requests:
        cpu: 250m
        memory: 512Mi

    livenessProbe:
      enabled: true
      exec:
        command: ["healthcheck-queue"]
      initialDelaySeconds: 30
      periodSeconds: 60
      timeoutSeconds: 5
      failureThreshold: 3

    autoscaling:
      enabled: false
      minReplicas: 1
      maxReplicas: 5
      targetCPUUtilizationPercentage: 70

    pdb:
      enabled: false

    sidecars: []
    env: []
    envFrom: []
    volumes: []
    volumeMounts: []
    initContainers: []

    nodeSelector: {}
    tolerations: []
    affinity: {}

  # ============================================================================
  # Example 4: Octane Swoole Worker (High-Performance)
  # ============================================================================
  # Runtime: http.entrypoint=none, php.engine=swoole
  # Image: Custom Laravel Octane image with Swoole
  # Command: php artisan queue:work
  # Use case: CPU-intensive background tasks that benefit from persistent memory

  octane-swoole-worker:
    enabled: false
    replicaCount: 1

    http:
      entrypoint: "none"
    php:
      engine: "swoole"

    image:
      repository: your-custom/laravel-octane
      tag: "swoole-latest"
      pullPolicy: IfNotPresent

    strategy:
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 1
        maxUnavailable: 0

    podAnnotations: {}
    podLabels: {}

    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 82
      fsGroup: 82
      seccompProfile:
        type: RuntimeDefault

    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      readOnlyRootFilesystem: true

    args:
      - "php"
      - "artisan"
      - "queue:work"

    resources:
      limits:
        cpu: 1000m
        memory: 1Gi
      requests:
        cpu: 250m
        memory: 512Mi

    livenessProbe:
      enabled: true
      exec:
        command: ["healthcheck-queue"]
      initialDelaySeconds: 30
      periodSeconds: 60
      timeoutSeconds: 5
      failureThreshold: 3

    autoscaling:
      enabled: false
      minReplicas: 1
      maxReplicas: 5
      targetCPUUtilizationPercentage: 70

    pdb:
      enabled: false

    sidecars: []
    env: []
    envFrom: []
    volumes: []
    volumeMounts: []
    initContainers: []

    nodeSelector: {}
    tolerations: []
    affinity: {}

  # ============================================================================
  # Example 5: Email Queue Worker (CLI)
  # ============================================================================
  # Runtime: http.entrypoint=none, php.engine=cli
  # Image: Official PHP CLI image
  # Command: php artisan queue:work --queue=emails
  # Use case: Dedicated worker for email queue

  emails:
    enabled: false
    replicaCount: 1

    http:
      entrypoint: "none"
    php:
      engine: "cli"

    image:
      repository: php
      tag: "8.3-cli"
      pullPolicy: IfNotPresent

    strategy:
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 1
        maxUnavailable: 0

    podAnnotations: {}
    podLabels: {}

    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 82
      fsGroup: 82
      seccompProfile:
        type: RuntimeDefault

    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      readOnlyRootFilesystem: true

    # Email queue worker command
    args:
      - "php"
      - "artisan"
      - "queue:work"
      - "--queue=emails"
      - "--tries=3"
      - "--timeout=120"

    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi

    livenessProbe:
      enabled: true
      exec:
        command: ["healthcheck-queue"]
      initialDelaySeconds: 30
      periodSeconds: 60
      timeoutSeconds: 5
      failureThreshold: 3

    autoscaling:
      enabled: false
      minReplicas: 1
      maxReplicas: 5
      targetCPUUtilizationPercentage: 70

    pdb:
      enabled: false

    sidecars: []
    env: []
    envFrom: []
    volumes: []
    volumeMounts: []
    initContainers: []

    nodeSelector: {}
    tolerations: []
    affinity: {}

# ============================================================================
# Jobs Configuration
# ============================================================================

# Scheduler (Laravel Cron)
scheduler:
  enabled: true
  schedule: "* * * * *"

  # Scheduler uses CLI runtime
  http:
    entrypoint: "none"
  php:
    engine: "cli"

  image:
    repository: php
    tag: "8.3-cli"
    pullPolicy: IfNotPresent

  podAnnotations: {}
  podLabels: {}

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 82

  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true

  command: ["php", "artisan", "schedule:run"]

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  restartPolicy: OnFailure

  nodeSelector: {}
  tolerations: []
  affinity: {}

# Migration Job - runs as a Helm hook before install/upgrade
migration:
  enabled: true

  # Migration uses CLI runtime
  http:
    entrypoint: "none"
  php:
    engine: "cli"

  image:
    repository: php
    tag: "8.3-cli"
    pullPolicy: IfNotPresent

  podAnnotations: {}
  podLabels: {}

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 82

  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true

  command: ["php", "artisan", "migrate", "--force"]

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi

  # Retry configuration
  backoffLimit: 3
  ttlSecondsAfterFinished: 300

  nodeSelector: {}
  tolerations: []
  affinity: {}

# ============================================================================
# Ingress Configuration
# ============================================================================

# Ingress configuration (legacy Kubernetes Ingress)
# Note: Use either ingress OR ingressRoute, not both
ingress:
  enabled: false
  className: traefik
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
  hosts:
    - host: app.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: laravel-tls
      hosts:
        - app.example.com

# Traefik IngressRoute configuration (modern CRD-based routing)
# This is the recommended approach for Traefik users
ingressRoute:
  enabled: true
  annotations: {}

  # Entry points to use (web, websecure, etc.)
  entryPoints:
    - websecure

  # Global middlewares applied to all routes
  # Reference format: "middleware-name" (same namespace) or "namespace/middleware-name"
  # The template will automatically prepend the fullname, so just use the suffix
  middlewares:
    - headers
    - compress
    - ratelimit
    - buffering

  # Routes configuration
  routes:
    - match: "Host(`app.example.com`)"
      kind: Rule
      priority: 10
      # Per-route middlewares (optional, combines with global middlewares)
      middlewares: []
      # Sticky sessions configuration (optional)
      sticky:
        cookieName: laravel_sticky
        secure: true
        httpOnly: true
        sameSite: lax
      # Service weight for A/B testing or canary deployments (optional)
      weight: 100
      # Response forwarding configuration (optional)
      responseForwarding:
        flushInterval: 100ms

  # TLS configuration
  tls:
    # Use existing TLS secret
    secretName: laravel-tls

    # OR use cert-resolver for automatic certificate generation
    # certResolver: letsencrypt-prod

    # Domain configuration for cert-resolver
    # domains:
    #   - main: app.example.com
    #     sans:
    #       - www.app.example.com

    # TLS options reference (optional)
    # options:
    #   name: tls-options
    #   namespace: default

# ============================================================================
# Traefik Middleware Configuration
# ============================================================================

middleware:
  enabled: true

  # Rate limiting
  rateLimit:
    enabled: true
    average: 100
    burst: 200
    period: 1s

  # Security headers
  headers:
    enabled: true
    browserXssFilter: true
    contentTypeNosniff: true
    forceSTSHeader: true
    stsIncludeSubdomains: true
    stsPreload: true
    stsSeconds: 31536000
    customFrameOptionsValue: "SAMEORIGIN"
    customResponseHeaders:
      X-Powered-By: ""
      Server: ""

  # Request compression
  compress:
    enabled: true

  # IP whitelist (disabled by default)
  ipWhiteList:
    enabled: false
    sourceRange: []
    # - 10.0.0.0/8
    # - 172.16.0.0/12

  # Redirect scheme (HTTP to HTTPS)
  redirectScheme:
    enabled: true
    scheme: https
    permanent: true
    # port: "443"

  # Strip prefix middleware
  stripPrefix:
    enabled: false
    prefixes: []
    # - /api/v1
    forceSlash: false

  # Retry middleware
  retry:
    enabled: false
    attempts: 3
    initialInterval: 100ms

  # Circuit breaker middleware
  circuitBreaker:
    enabled: false
    expression: "NetworkErrorRatio() > 0.30"
    checkPeriod: 10s
    fallbackDuration: 10s
    recoveryDuration: 10s

  # In-flight requests limiter
  inFlightReq:
    enabled: false
    amount: 100
    sourceCriterion:
      ipStrategy:
        depth: 1
        excludedIPs: []
      # requestHeaderName: X-Forwarded-For
      # requestHost: true

  # Middleware chain (combine multiple middlewares)
  chain:
    enabled: false
    middlewares: []
    # - headers
    # - ratelimit
    # - compress

  # Buffering middleware (request/response body size limits)
  buffering:
    enabled: true
    # Maximum request body size
    maxRequestBodyBytes: 104857600  # 100MB in bytes
    # Memory buffer for request body (rest goes to disk)
    memRequestBodyBytes: 1048576    # 1MB in bytes
    # Maximum response body size
    # maxResponseBodyBytes: 0  # 0 = unlimited
    # Memory buffer for response body
    # memResponseBodyBytes: 1048576
    # Retry expression for failed requests
    # retryExpression: "IsNetworkError() && Attempts() < 2"

# ============================================================================
# Laravel & PHP Configuration
# ============================================================================
# Global environment variables shared across ALL deployments (web, workers, scheduler, migration)
# These are merged into a ConfigMap and Secret and injected into every deployment
#
# For deployment-specific environment overrides, use the 'env' field in the
# respective deployment configuration (e.g., web.env, workers.default.env)

# Laravel application configuration
laravel:
  # Environment variables from ConfigMap
  env:
    APP_NAME: "Laravel"
    APP_ENV: "production"
    APP_DEBUG: "false"
    APP_URL: "https://app.example.com"

    LOG_CHANNEL: "stderr"
    LOG_LEVEL: "warning"

    # Database and Redis connection are configured via DATABASE_URL and REDIS_URL in secrets
    # If you need to use individual connection variables instead:
    #   1. Set DATABASE_URL: "" (empty string) in secrets
    #   2. Add DB_CONNECTION, DB_HOST, DB_PORT, DB_DATABASE, DB_USERNAME, DB_PASSWORD here/in secrets
    # Same applies for Redis: set REDIS_URL: "" and add REDIS_HOST, REDIS_PORT, REDIS_PASSWORD

    # Application drivers
    BROADCAST_DRIVER: "redis"
    CACHE_DRIVER: "redis"
    FILESYSTEM_DISK: "local"  # Or "s3" for cloud storage
    QUEUE_CONNECTION: "redis"
    SESSION_DRIVER: "redis"
    SESSION_LIFETIME: "120"

    REDIS_CLIENT: "phpredis"

    MAIL_MAILER: "smtp"
    MAIL_HOST: "mailpit"
    MAIL_PORT: "1025"
    MAIL_ENCRYPTION: "null"
    MAIL_FROM_ADDRESS: "noreply@example.com"
    MAIL_FROM_NAME: "Laravel App"

    AWS_DEFAULT_REGION: "us-east-1"

    VITE_APP_NAME: "Laravel"

  # Sensitive environment variables from Secret
  # All secrets should be provided via secrets.yaml (gitignored) or external secrets
  secrets:
    APP_KEY: ""

    # Database connection URL (recommended)
    # Format: postgresql://user:pass@host:port/database?sslmode=require
    # For MySQL: mysql://user:pass@host:port/database
    # To use individual DB_* variables instead, set this to "" and add them in laravel.env above
    DATABASE_URL: ""

    # Redis connection URL (recommended)
    # Format: redis://default:password@host:port (or rediss:// for TLS)
    # To use individual REDIS_* variables instead, set this to "" and add them in laravel.env above
    REDIS_URL: ""

    # Cloud storage credentials
    AWS_ACCESS_KEY_ID: ""
    AWS_SECRET_ACCESS_KEY: ""
    MAIL_USERNAME: ""
    MAIL_PASSWORD: ""
    PUSHER_APP_ID: ""
    PUSHER_APP_KEY: ""
    PUSHER_APP_SECRET: ""

# ============================================================================
# Temporary Filesystem Volumes
# ============================================================================
# Required when readOnlyRootFilesystem is enabled
# These tmpfs volumes provide writable directories for Laravel

tmpfsVolumes:
  enabled: true
  mounts:
    - name: cache
      mountPath: /var/www/html/storage/framework/cache
    - name: sessions
      mountPath: /var/www/html/storage/framework/sessions
    - name: views
      mountPath: /var/www/html/storage/framework/views
    - name: bootstrap-cache
      mountPath: /var/www/html/bootstrap/cache
    - name: tmp
      mountPath: /tmp

# ============================================================================
# Persistence Configuration
# ============================================================================

persistence:
  enabled: true
  storageClass: ""
  accessMode: ReadWriteOnce
  size: 1Gi
  # Mount paths for persistent storage
  mounts:
    - name: storage
      mountPath: /var/www/html/storage/app
      subPath: app
    - name: storage
      mountPath: /var/www/html/storage/logs
      subPath: logs

# ============================================================================
# External Secrets Configuration
# ============================================================================
# If using external secrets operator

externalSecrets:
  enabled: false
  backendType: secretsManager
  region: us-east-1
  data: []
