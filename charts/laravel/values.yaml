# Default values for Laravel Helm chart
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Global settings
global:
  environment: production

# Image configuration
image:
  repository: your-registry/laravel-app
  pullPolicy: IfNotPresent
  tag: "latest"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# ServiceAccount configuration
serviceAccount:
  create: true
  annotations: {}
  name: ""

# Web application configuration
web:
  enabled: true
  replicaCount: 2
  
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
  
  podLabels: {}
  
  podSecurityContext:
    runAsNonRoot: true
    # For local development, set to your host user IDs (run: id -u && id -g) to avoid permission issues
    # For production, use a dedicated non-root user ID (e.g., 1000)
    runAsUser: 1000 # Replace with: id -u
    fsGroup: 1000   # Replace with: id -g
    seccompProfile:
      type: RuntimeDefault
  
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
  
  service:
    type: ClusterIP
    port: 80
    targetPort: 8080
    annotations: {}
  
  resources:
    limits:
      cpu: 1000m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi
  
  livenessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 8080
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  
  readinessProbe:
    enabled: true
    httpGet:
      path: /ready
      port: 8080
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    successThreshold: 1
    failureThreshold: 3
  
  startupProbe:
    enabled: true
    httpGet:
      path: /health
      port: 8080
    initialDelaySeconds: 0
    periodSeconds: 5
    timeoutSeconds: 3
    successThreshold: 1
    failureThreshold: 30
  
  # Autoscaling configuration
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
        - type: Percent
          value: 50
          periodSeconds: 60
      scaleUp:
        stabilizationWindowSeconds: 0
        policies:
        - type: Percent
          value: 100
          periodSeconds: 15
        - type: Pods
          value: 2
          periodSeconds: 15
        selectPolicy: Max
  
  # Pod Disruption Budget
  pdb:
    enabled: true
    minAvailable: 1
  
  nodeSelector: {}
  tolerations: []
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
              - laravel
            - key: app.kubernetes.io/component
              operator: In
              values:
              - web
          topologyKey: kubernetes.io/hostname

# Worker configuration (Queue workers, etc.)
worker:
  enabled: true
  replicaCount: 2
  
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  
  podAnnotations: {}
  podLabels: {}
  
  podSecurityContext:
    runAsNonRoot: true
    # For local development, set to your host user IDs (run: id -u && id -g) to avoid permission issues
    # For production, use a dedicated non-root user ID (e.g., 1000)
    runAsUser: 1000 # Replace with: id -u
    fsGroup: 1000   # Replace with: id -g
    seccompProfile:
      type: RuntimeDefault
  
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
  
  # Worker command - Laravel Horizon (recommended) or basic queue worker
  # Horizon: Provides dashboard, auto-balancing, metrics at /horizon
  command: ["php", "artisan", "horizon"]
  
  # Alternative: Basic queue worker (without Horizon)
  # command: ["php", "artisan", "queue:work"]
  # args:
  #   - "--verbose"
  #   - "--tries=3"
  #   - "--max-time=3600"
  #   - "--sleep=3"
  #   - "--timeout=300"
  
  # Horizon manages its own worker configuration via config/horizon.php
  # No args needed when using Horizon
  args: []
  
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi
  
  livenessProbe:
    enabled: true
    exec:
      command:
      - php
      - artisan
      - queue:health
    initialDelaySeconds: 30
    periodSeconds: 60
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  
  # Autoscaling configuration for workers
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  
  # Pod Disruption Budget for workers
  pdb:
    enabled: true
    minAvailable: 1
  
  nodeSelector: {}
  tolerations: []
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
              - laravel
            - key: app.kubernetes.io/component
              operator: In
              values:
              - worker
          topologyKey: kubernetes.io/hostname

# Scheduler (Laravel Cron)
scheduler:
  enabled: true
  schedule: "* * * * *"
  
  podAnnotations: {}
  podLabels: {}
  
  # Minimal security context for short-lived cron job
  # Set to your host user ID if needed (run: id -u)
  # Note: scheduler is a short-lived job, fsGroup not needed
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000 # Replace with: id -u
  
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
  
  command: ["php", "artisan", "schedule:run"]
  
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi
  
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  restartPolicy: OnFailure
  
  nodeSelector: {}
  tolerations: []
  affinity: {}

# Migration Job - runs as a Helm hook before install/upgrade
migration:
  enabled: true
  
  podAnnotations: {}
  podLabels: {}
  
  # Minimal security context for short-lived cron job
  # Set to your host user ID if needed (run: id -u)
  # Note: scheduler is a short-lived job, fsGroup not needed
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000 # Replace with: id -u
  
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
  
  command: ["php", "artisan", "migrate", "--force"]
  
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi
  
  # Retry configuration
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  
  nodeSelector: {}
  tolerations: []
  affinity: {}

# Ingress configuration (legacy Kubernetes Ingress)
# Note: Use either ingress OR ingressRoute, not both
ingress:
  enabled: false
  className: traefik
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
  hosts:
    - host: app.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: laravel-tls
      hosts:
        - app.example.com

# Traefik IngressRoute configuration (modern CRD-based routing)
# This is the recommended approach for Traefik users
ingressRoute:
  enabled: true
  annotations: {}

  # Entry points to use (web, websecure, etc.)
  entryPoints:
    - websecure

  # Global middlewares applied to all routes
  # Reference format: "middleware-name" (same namespace) or "namespace/middleware-name"
  # The template will automatically prepend the fullname, so just use the suffix
  middlewares:
    - headers
    - compress
    - ratelimit

  # Routes configuration
  routes:
    - match: "Host(`app.example.com`)"
      kind: Rule
      priority: 10
      # Per-route middlewares (optional, combines with global middlewares)
      middlewares: []
      # Sticky sessions configuration (optional)
      sticky:
        cookieName: laravel_sticky
        secure: true
        httpOnly: true
        sameSite: lax
      # Service weight for A/B testing or canary deployments (optional)
      weight: 100
      # Response forwarding configuration (optional)
      responseForwarding:
        flushInterval: 100ms

  # TLS configuration
  tls:
    # Use existing TLS secret
    secretName: laravel-tls

    # OR use cert-resolver for automatic certificate generation
    # certResolver: letsencrypt-prod

    # Domain configuration for cert-resolver
    # domains:
    #   - main: app.example.com
    #     sans:
    #       - www.app.example.com

    # TLS options reference (optional)
    # options:
    #   name: tls-options
    #   namespace: default

# Traefik Middleware configuration
middleware:
  enabled: true
  # Rate limiting
  rateLimit:
    enabled: true
    average: 100
    burst: 200
    period: 1s
  
  # Security headers
  headers:
    enabled: true
    browserXssFilter: true
    contentTypeNosniff: true
    forceSTSHeader: true
    stsIncludeSubdomains: true
    stsPreload: true
    stsSeconds: 31536000
    customFrameOptionsValue: "SAMEORIGIN"
    customResponseHeaders:
      X-Powered-By: ""
      Server: ""
  
  # Request compression
  compress:
    enabled: true
  
  # IP whitelist (disabled by default)
  ipWhiteList:
    enabled: false
    sourceRange: []
    # - 10.0.0.0/8
    # - 172.16.0.0/12
  
  # Redirect scheme (HTTP to HTTPS)
  redirectScheme:
    enabled: true
    scheme: https
    permanent: true
    # port: "443"

  # Strip prefix middleware
  stripPrefix:
    enabled: false
    prefixes: []
    # - /api/v1
    forceSlash: false

  # Retry middleware
  retry:
    enabled: false
    attempts: 3
    initialInterval: 100ms

  # Circuit breaker middleware
  circuitBreaker:
    enabled: false
    expression: "NetworkErrorRatio() > 0.30"
    checkPeriod: 10s
    fallbackDuration: 10s
    recoveryDuration: 10s

  # In-flight requests limiter
  inFlightReq:
    enabled: false
    amount: 100
    sourceCriterion:
      ipStrategy:
        depth: 1
        excludedIPs: []
      # requestHeaderName: X-Forwarded-For
      # requestHost: true

  # Middleware chain (combine multiple middlewares)
  chain:
    enabled: false
    middlewares: []
    # - headers
    # - ratelimit
    # - compress

# Laravel application configuration
laravel:
  # Environment variables from ConfigMap
  env:
    APP_NAME: "Laravel"
    APP_ENV: "production"
    APP_DEBUG: "false"
    APP_URL: "https://app.example.com"
    
    LOG_CHANNEL: "stderr"
    LOG_LEVEL: "info"
    
    DB_CONNECTION: "mysql"
    DB_HOST: "mysql"
    DB_PORT: "3306"
    DB_DATABASE: "laravel"
    
    BROADCAST_DRIVER: "redis"
    CACHE_DRIVER: "redis"
    FILESYSTEM_DISK: "local"
    QUEUE_CONNECTION: "redis"
    SESSION_DRIVER: "redis"
    SESSION_LIFETIME: "120"
    
    REDIS_HOST: "redis"
    REDIS_PORT: "6379"
    
    MAIL_MAILER: "smtp"
    MAIL_HOST: "mailpit"
    MAIL_PORT: "1025"
    MAIL_ENCRYPTION: "null"
    MAIL_FROM_ADDRESS: "noreply@example.com"
    MAIL_FROM_NAME: "Laravel App"
    
    AWS_DEFAULT_REGION: "us-east-1"
    
    VITE_APP_NAME: "Laravel"

  # Sensitive environment variables from Secret
  secrets:
    APP_KEY: ""
    DB_USERNAME: "laravel"
    DB_PASSWORD: ""
    REDIS_PASSWORD: ""
    AWS_ACCESS_KEY_ID: ""
    AWS_SECRET_ACCESS_KEY: ""
    MAIL_USERNAME: ""
    MAIL_PASSWORD: ""
    PUSHER_APP_ID: ""
    PUSHER_APP_KEY: ""
    PUSHER_APP_SECRET: ""

# Temporary filesystem volumes for Laravel writable directories
# These are required when readOnlyRootFilesystem is enabled
tmpfsVolumes:
  enabled: true
  mounts:
    - name: cache
      mountPath: /var/www/html/storage/framework/cache
    - name: sessions
      mountPath: /var/www/html/storage/framework/sessions
    - name: views
      mountPath: /var/www/html/storage/framework/views
    - name: tmp
      mountPath: /tmp

# Persistence configuration
persistence:
  enabled: true
  storageClass: ""
  accessMode: ReadWriteOnce
  size: 10Gi
  # Mount paths for persistent storage
  mounts:
    - name: storage
      mountPath: /var/www/html/storage/app
      subPath: app
    - name: storage
      mountPath: /var/www/html/storage/logs
      subPath: logs

# External secrets (if using external secrets operator)
externalSecrets:
  enabled: false
  backendType: secretsManager
  region: us-east-1
  data: []

# Init containers (for cache warming)
initContainers:
  cacheConfig:
    enabled: true
    command: ["php", "artisan", "config:cache"]
  cacheRoute:
    enabled: true
    command: ["php", "artisan", "route:cache"]
  cacheView:
    enabled: true
    command: ["php", "artisan", "view:cache"]
  storageLink:
    enabled: true
    command: ["php", "artisan", "storage:link"]

# Additional init containers
extraInitContainers: []

# Sidecar containers
sidecars: []

# Extra volumes
extraVolumes: []

# Extra volume mounts
extraVolumeMounts: []

# Extra environment variables
extraEnv: []

# Extra environment variables from ConfigMaps/Secrets
extraEnvFrom: []
