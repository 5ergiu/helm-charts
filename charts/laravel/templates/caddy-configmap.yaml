{{- if .Values.http }}
{{- if .Values.http.caddy }}
{{- if .Values.http.caddy.enabled }}
{{- $caddyConfig := .Values.http.caddy }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "laravel.fullname" . }}-caddy
  labels:
    {{- include "laravel.labels" . | nindent 4 }}
data:
  Caddyfile: |
    {
        # Global options
        admin off
        auto_https off

        # Logging
        log {
            {{- if $caddyConfig.accessLog }}
            output stdout
            format json
            {{- else }}
            output discard
            {{- end }}
        }
    }

    :{{ $caddyConfig.port | default 8080 }} {
        # Root directory
        root * {{ $caddyConfig.root | default "/var/www/html/public" }}

        # Security headers
        header {
            -Server
            -X-Powered-By
        }

        # Request size limit
        request_body {
            max_size {{ $caddyConfig.maxBodySize | default "100MB" }}
        }

        # Healthcheck endpoint
        @healthcheck {
            path /healthcheck
        }
        handle @healthcheck {
            reverse_proxy 127.0.0.1:9000 {
                transport fastcgi {
                    env SCRIPT_FILENAME /healthcheck
                    env SCRIPT_NAME /healthcheck
                }
            }
        }

        # PHP files
        @phpFiles {
            path *.php
        }
        handle @phpFiles {
            reverse_proxy 127.0.0.1:9000 {
                transport fastcgi {
                    split .php
                    env SCRIPT_FILENAME {path}
                }
            }
        }

        # Static files with caching
        @static {
            path *.css *.js *.jpg *.jpeg *.png *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot *.webp *.mp3 *.mp4 *.webm
        }
        handle @static {
            header Cache-Control "public, max-age=31536000, immutable"
            try_files {path} /index.php?{query}
        }

        # Favicon and robots.txt - serve directly or fallback to Laravel
        @favrobot {
            path /favicon.ico /robots.txt
        }
        handle @favrobot {
            try_files {path} /index.php?{query}
        }

        # Deny access to hidden files (except .well-known)
        @hidden {
            path */.*
            not path /.well-known/*
        }
        handle @hidden {
            respond 404
        }

        # Laravel routing - fallback to index.php
        try_files {path} /index.php?{query}

        # PHP handler for index.php fallback
        handle {
            reverse_proxy 127.0.0.1:9000 {
                transport fastcgi {
                    split .php
                    env SCRIPT_FILENAME {http.request.uri.path}
                    resolve_root_symlink
                }
            }
        }

        # File server for static files
        file_server

        # Enable compression
        encode gzip zstd

        # Access log
        {{- if $caddyConfig.accessLog }}
        log {
            output stdout
            format json
        }
        {{- end }}
    }
{{- end }}
