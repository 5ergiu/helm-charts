{{- if .Values.web.reverseProxy.nginx.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "laravel.fullname" . }}-nginx
  labels:
    {{- include "laravel.labels" . | nindent 4 }}
data:
  nginx.conf: |
    worker_processes auto;
    error_log /dev/stderr warn;
    pid /tmp/nginx.pid;

    events {
        worker_connections 1024;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # Logging
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        # Disable access logs (use Traefik logs instead)
        access_log off;

        # Temporary file paths for read-only filesystem
        client_body_temp_path /tmp/nginx 1 2;
        proxy_temp_path /tmp/nginx-proxy;
        fastcgi_temp_path /tmp/nginx-fastcgi;
        uwsgi_temp_path /tmp/nginx-uwsgi;
        scgi_temp_path /tmp/nginx-scgi;

        # Client body size - should match or exceed Traefik's buffering.maxRequestBodyBytes
        # This prevents nginx from rejecting requests that Traefik would allow
        client_max_body_size {{ .Values.web.reverseProxy.nginx.clientMaxBodySize }};

        # Performance
        sendfile on;
        keepalive_timeout {{ .Values.web.reverseProxy.nginx.keepaliveTimeout }};

        server {
            listen {{ .Values.web.reverseProxy.nginx.port }};
            listen [::]:{{ .Values.web.reverseProxy.nginx.port }};

            root /var/www/html/public;
            index index.php index.html;

            server_name _;
            server_tokens off;

            # Disable absolute redirects
            absolute_redirect off;

            # Healthcheck endpoint
            location /healthcheck {
                fastcgi_read_timeout 5s;
                include fastcgi_params;
                fastcgi_param SCRIPT_NAME /healthcheck;
                fastcgi_param SCRIPT_FILENAME /healthcheck;
                fastcgi_pass 127.0.0.1:9000;
            }

            # Laravel routing - try files first, then pass to index.php
            location / {
                try_files $uri $uri/ /index.php?$query_string;
            }

            # PHP-FPM handler
            location ~ \.php$ {
                fastcgi_pass 127.0.0.1:9000;
                fastcgi_index index.php;
                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                include fastcgi_params;
                fastcgi_buffers 8 8k;
                fastcgi_buffer_size 8k;
                fastcgi_read_timeout {{ .Values.web.reverseProxy.nginx.fastcgiReadTimeout }};
            }

            # Favicon
            location = /favicon.ico {
                log_not_found off;
                access_log off;
            }

            # Robots.txt - pass to Laravel for dynamic handling
            location = /robots.txt {
                log_not_found off;
                access_log off;
                try_files $uri /index.php?$query_string;
            }

            # Static assets - serve directly with caching
            location ~* \.(?:css|js|jpe?g|png|gif|ico|cur|heic|webp|tiff?|mp3|m4a|aac|ogg|midi?|wav|mp4|mov|webm|mpe?g|avi|ogv|flv|wmv|svgz?)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
                access_log off;
                log_not_found off;
                # Fallback to Laravel if file doesn't exist
                try_files $uri /index.php?$query_string;
            }

            # Fonts
            location ~* \.(?:ttf|ttc|otf|eot|woff2?)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
                access_log off;
            }

            # Prevent access to hidden files (except .well-known for Let's Encrypt)
            location ~ /\.(?!well-known) {
                deny all;
            }
        }
    }
{{- end }}
