{{/*
Web Deployment
*/}}
{{- if .Values.web.enabled }}
{{- $runtime := include "laravel.getRuntimeConfig" (dict "root" . "config" .Values.web) | fromYaml }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "laravel.fullname" . }}-web
  labels:
    {{- include "laravel.labels" . | nindent 4 }}
    app.kubernetes.io/component: web
spec:
  {{- if not .Values.web.autoscaling.enabled }}
  replicas: {{ .Values.web.replicaCount }}
  {{- end }}
  strategy:
    {{- toYaml .Values.web.strategy | nindent 4 }}
  selector:
    matchLabels:
      {{- include "laravel.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: web
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print .Template.BasePath "/configmap.yaml") . | sha256sum }}
        {{- if .Values.laravel.secret }}
        checksum/secret: {{ include (print .Template.BasePath "/secret.yaml") . | sha256sum }}
        {{- end }}
        {{- with .Values.web.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "laravel.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: web
        {{- with .Values.web.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "laravel.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.web.podSecurityContext | nindent 8 }}
      {{- with .Values.web.initContainers }}
      initContainers:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: php
          securityContext:
            {{- toYaml .Values.web.securityContext | nindent 12 }}
          image: "{{ .Values.web.image.repository }}:{{ .Values.web.image.tag }}"
          imagePullPolicy: {{ .Values.web.image.pullPolicy }}
          {{- with .Values.web.command }}
          command:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.web.args }}
          args:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.web.ports }}
          ports:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          envFrom:
            {{- include "laravel.envConfigMap" . | nindent 12 }}
            {{- include "laravel.envSecret" . | nindent 12 }}
          {{- with .Values.web.envFrom }}
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.web.env }}
          env:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- if .Values.web.livenessProbe }}
          {{- if .Values.web.livenessProbe.enabled }}
          livenessProbe:
            {{- omit .Values.web.livenessProbe "enabled" | toYaml | nindent 12 }}
          {{- end }}
          {{- end }}
          {{- if .Values.web.readinessProbe }}
          {{- if .Values.web.readinessProbe.enabled }}
          readinessProbe:
            {{- omit .Values.web.readinessProbe "enabled" | toYaml | nindent 12 }}
          {{- end }}
          {{- end }}
          {{- if .Values.web.startupProbe }}
          {{- if .Values.web.startupProbe.enabled }}
          startupProbe:
            {{- omit .Values.web.startupProbe "enabled" | toYaml | nindent 12 }}
          {{- end }}
          {{- end }}
          resources:
            {{- toYaml .Values.web.resources | nindent 12 }}
          volumeMounts:
            {{- with .Values.web.volumeMounts }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
            {{- include "laravel.phpConfigVolumeMounts" (dict "root" . "runtime" $runtime) | nindent 12 }}
            {{- if .Values.tmpfsVolumes.enabled }}
            {{- range .Values.tmpfsVolumes.mounts }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
            {{- end }}
            {{- end }}
            {{- if .Values.persistence.enabled }}
            {{- range .Values.persistence.mounts }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
            {{- end }}
            {{- end }}
        {{- with .Values.web.sidecars }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- if $runtime.components.httpSidecar }}
        {{- include "laravel.httpSidecar" (dict "root" . "runtime" $runtime) | nindent 8 }}
        {{- end }}
      volumes:
        {{- with .Values.web.volumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- include "laravel.phpConfigVolumes" (dict "root" . "runtime" $runtime) | nindent 8 }}
        {{- include "laravel.httpVolumes" (dict "root" . "runtime" $runtime) | nindent 8 }}
        {{- if .Values.tmpfsVolumes.enabled }}
        {{- range .Values.tmpfsVolumes.mounts }}
        - name: {{ .name }}
          emptyDir: {}
        {{- end }}
        {{- end }}
        {{- if .Values.persistence.enabled }}
        - name: storage
          persistentVolumeClaim:
            claimName: {{ include "laravel.fullname" . }}-storage
        {{- end }}
      {{- with .Values.web.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.web.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.web.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

{{/*
Worker Deployments - iterate over all worker deployment variants
*/}}
{{- range $workerName, $workerConfig := .Values.workers }}
{{- if $workerConfig.enabled }}
{{- $runtime := include "laravel.getRuntimeConfig" (dict "root" $ "config" $workerConfig) | fromYaml }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "laravel.fullname" $ }}-worker-{{ $workerName }}
  labels:
    {{- include "laravel.labels" $ | nindent 4 }}
    app.kubernetes.io/component: worker
spec:
  {{- if not $workerConfig.autoscaling.enabled }}
  replicas: {{ $workerConfig.replicaCount }}
  {{- end }}
  strategy:
    {{- toYaml $workerConfig.strategy | nindent 4 }}
  selector:
    matchLabels:
      {{- include "laravel.selectorLabels" $ | nindent 6 }}
      app.kubernetes.io/component: worker
      app.kubernetes.io/variant: {{ $workerName }}
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") $ | sha256sum }}
        {{- if $.Values.laravel.secret }}
        checksum/secret: {{ include (print $.Template.BasePath "/secret.yaml") $ | sha256sum }}
        {{- end }}
        {{- with $workerConfig.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "laravel.selectorLabels" $ | nindent 8 }}
        app.kubernetes.io/component: worker
        app.kubernetes.io/variant: {{ $workerName }}
        {{- with $workerConfig.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with $.Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "laravel.serviceAccountName" $ }}
      securityContext:
        {{- toYaml $workerConfig.podSecurityContext | nindent 8 }}
      {{- with $workerConfig.initContainers }}
      initContainers:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: worker
          securityContext:
            {{- toYaml $workerConfig.securityContext | nindent 12 }}
          image: "{{ $workerConfig.image.repository }}:{{ $workerConfig.image.tag }}"
          imagePullPolicy: {{ $workerConfig.image.pullPolicy }}
          {{- with $workerConfig.command }}
          command:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with $workerConfig.args }}
          args:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with $workerConfig.ports }}
          ports:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          envFrom:
            {{- include "laravel.envConfigMap" $ | nindent 12 }}
            {{- include "laravel.envSecret" $ | nindent 12 }}
          {{- with $workerConfig.envFrom }}
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with $workerConfig.env }}
          env:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- if $workerConfig.livenessProbe }}
          {{- if $workerConfig.livenessProbe.enabled }}
          livenessProbe:
            {{- omit $workerConfig.livenessProbe "enabled" | toYaml | nindent 12 }}
          {{- end }}
          {{- end }}
          {{- if $workerConfig.readinessProbe }}
          {{- if $workerConfig.readinessProbe.enabled }}
          readinessProbe:
            {{- omit $workerConfig.readinessProbe "enabled" | toYaml | nindent 12 }}
          {{- end }}
          {{- end }}
          {{- if $workerConfig.startupProbe }}
          {{- if $workerConfig.startupProbe.enabled }}
          startupProbe:
            {{- omit $workerConfig.startupProbe "enabled" | toYaml | nindent 12 }}
          {{- end }}
          {{- end }}
          resources:
            {{- toYaml $workerConfig.resources | nindent 12 }}
          volumeMounts:
            {{- with $workerConfig.volumeMounts }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
            {{- include "laravel.phpConfigVolumeMounts" (dict "root" $ "runtime" $runtime) | nindent 12 }}
            {{- if $.Values.tmpfsVolumes.enabled }}
            {{- range $.Values.tmpfsVolumes.mounts }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
            {{- end }}
            {{- end }}
            {{- if $.Values.persistence.enabled }}
            {{- range $.Values.persistence.mounts }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
            {{- end }}
            {{- end }}
        {{- with $workerConfig.sidecars }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      volumes:
        {{- with $workerConfig.volumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- include "laravel.phpConfigVolumes" (dict "root" $ "runtime" $runtime) | nindent 8 }}
        {{- if $.Values.tmpfsVolumes.enabled }}
        {{- range $.Values.tmpfsVolumes.mounts }}
        - name: {{ .name }}
          emptyDir: {}
        {{- end }}
        {{- end }}
        {{- if $.Values.persistence.enabled }}
        - name: storage
          persistentVolumeClaim:
            claimName: {{ include "laravel.fullname" $ }}-storage
        {{- end }}
      {{- with $workerConfig.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $workerConfig.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $workerConfig.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
{{- end }}
