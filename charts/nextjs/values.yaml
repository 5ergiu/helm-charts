# ============================================================================
# Default Values for Next.js Helm Chart
# ============================================================================
# Production-grade configuration for Next.js applications
# - High availability with autoscaling
# - Standalone mode (no external dependencies required)
# - Optional PostgreSQL/Redis support
# - Security hardened (read-only filesystem, non-root user)
# - Traefik ingress with TLS support
# - SSR/SSG fully supported
#
# For different deployment scenarios, see the examples directory:
#   - examples/nextjs/values.ci.yaml    - CI/CD optimized (zero dependencies)
#   - examples/nextjs/values.test.yaml  - Local testing (minimal resources)
#   - examples/nextjs/values.local.yaml - Development configuration
#   - examples/nextjs/values.prod.yaml  - Enterprise production template
#
# Chart Documentation: https://github.com/5ergiu/helm-charts/tree/main/charts/nextjs
# ============================================================================

# Global settings
global:
  environment: production

# Image configuration
image:
  repository: ghcr.io/5ergiu/nextjs
  pullPolicy: Always
  tag: latest

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# ServiceAccount configuration
serviceAccount:
  create: true
  annotations: {}
  name: ""

# Application deployment configuration
app:
  enabled: true
  replicaCount: 2
  
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
  
  podLabels: {}
  
  podSecurityContext:
    runAsNonRoot: true
    # For local development, set to your host user IDs (run: id -u && id -g) to avoid permission issues
    # For production, use a dedicated non-root user ID (e.g., 1000)
    runAsUser: 1000 # Replace with: id -u
    fsGroup: 1000   # Replace with: id -g
    seccompProfile:
      type: RuntimeDefault
  
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
  
  service:
    type: ClusterIP
    port: 80
    targetPort: 3000
    annotations: {}
  
  resources:
    limits:
      cpu: 1000m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi
  
  livenessProbe:
    enabled: true
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3
  
  readinessProbe:
    enabled: true
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    successThreshold: 1
    failureThreshold: 3
  
  startupProbe:
    enabled: true
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 0
    periodSeconds: 5
    timeoutSeconds: 3
    successThreshold: 1
    failureThreshold: 30
  
  # Autoscaling configuration
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
        - type: Percent
          value: 50
          periodSeconds: 60
      scaleUp:
        stabilizationWindowSeconds: 0
        policies:
        - type: Percent
          value: 100
          periodSeconds: 15
        - type: Pods
          value: 2
          periodSeconds: 15
        selectPolicy: Max
  
  # Pod Disruption Budget
  pdb:
    enabled: true
    minAvailable: 1
  
  nodeSelector: {}
  tolerations: []
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
              - nextjs
            - key: app.kubernetes.io/component
              operator: In
              values:
              - app
          topologyKey: kubernetes.io/hostname

# Ingress configuration (legacy Kubernetes Ingress)
# Note: Use either ingress OR ingressRoute, not both
ingress:
  enabled: false
  className: traefik
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
  hosts:
    - host: app.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: nextjs-tls
      hosts:
        - app.example.com

# Traefik IngressRoute configuration (modern CRD-based routing)
# This is the recommended approach for Traefik users
ingressRoute:
  enabled: true
  annotations: {}

  # Entry points to use (web, websecure, etc.)
  entryPoints:
    - websecure

  # Global middlewares applied to all routes
  # Reference format: "middleware-name" (same namespace) or "namespace/middleware-name"
  # The template will automatically prepend the fullname, so just use the suffix
  middlewares:
    - headers
    - compress
    - ratelimit

  # Routes configuration
  routes:
    - match: "Host(`app.example.com`)"
      kind: Rule
      priority: 10
      # Per-route middlewares (optional, combines with global middlewares)
      middlewares: []
      # Sticky sessions configuration (optional)
      sticky:
        cookieName: nextjs_sticky
        secure: true
        httpOnly: true
        sameSite: lax
      # Service weight for A/B testing or canary deployments (optional)
      weight: 100
      # Response forwarding configuration (optional)
      responseForwarding:
        flushInterval: 100ms

  # TLS configuration
  tls:
    # Use existing TLS secret
    secretName: nextjs-tls

    # OR use cert-resolver for automatic certificate generation
    # certResolver: letsencrypt-prod

    # Domain configuration for cert-resolver
    # domains:
    #   - main: app.example.com
    #     sans:
    #       - www.app.example.com

    # TLS options reference (optional)
    # options:
    #   name: tls-options
    #   namespace: default

# Traefik Middleware configuration
middleware:
  enabled: true
  # Rate limiting
  rateLimit:
    enabled: true
    average: 100
    burst: 200
    period: 1s
  
  # Security headers
  headers:
    enabled: true
    browserXssFilter: true
    contentTypeNosniff: true
    forceSTSHeader: true
    stsIncludeSubdomains: true
    stsPreload: true
    stsSeconds: 31536000
    customFrameOptionsValue: "SAMEORIGIN"
    customResponseHeaders:
      X-Powered-By: ""
      Server: ""
  
  # Request compression
  compress:
    enabled: true
  
  # IP whitelist (disabled by default)
  ipWhiteList:
    enabled: false
    sourceRange: []
    # - 10.0.0.0/8
    # - 172.16.0.0/12
  
  # Redirect scheme (HTTP to HTTPS)
  redirectScheme:
    enabled: true
    scheme: https
    permanent: true
    # port: "443"

  # Strip prefix middleware
  stripPrefix:
    enabled: false
    prefixes: []
    # - /api/v1
    forceSlash: false

  # Retry middleware
  retry:
    enabled: false
    attempts: 3
    initialInterval: 100ms

  # Circuit breaker middleware
  circuitBreaker:
    enabled: false
    expression: "NetworkErrorRatio() > 0.30"
    checkPeriod: 10s
    fallbackDuration: 10s
    recoveryDuration: 10s

  # In-flight requests limiter
  inFlightReq:
    enabled: false
    amount: 100
    sourceCriterion:
      ipStrategy:
        depth: 1
        excludedIPs: []
      # requestHeaderName: X-Forwarded-For
      # requestHost: true

  # Middleware chain (combine multiple middlewares)
  chain:
    enabled: false
    middlewares: []
    # - headers
    # - ratelimit
    # - compress

# Next.js application configuration
nextjs:
  # Build-time environment variables (public)
  # These are embedded in the build and exposed to the browser
  publicEnv:
    NEXT_PUBLIC_APP_NAME: "Next.js App"
    NEXT_PUBLIC_APP_URL: "https://app.example.com"
    NEXT_PUBLIC_API_URL: "https://api.example.com"
  
  # Runtime environment variables (server-side only)
  # These are NOT exposed to the browser
  env:
    NODE_ENV: "production"
    PORT: "3000"
    HOSTNAME: "0.0.0.0"
    
    # Next.js configuration
    NEXT_TELEMETRY_DISABLED: "1"
    
    # Logging
    LOG_LEVEL: "info"

    # Email/SMTP (non-sensitive config)
    SMTP_PORT: "587"
    SMTP_FROM: "noreply@example.com"

    # AWS/S3 (for image optimization or storage)
    AWS_REGION: "us-east-1"
    AWS_S3_BUCKET: ""
    
    # Analytics
    NEXT_PUBLIC_GOOGLE_ANALYTICS: ""
    
    # Feature flags
    NEXT_PUBLIC_ENABLE_ANALYTICS: "false"

  # Sensitive environment variables from Secret
  # All secrets should be provided via secrets.local.yaml (gitignored) or external secrets
  secrets:
    # Database credentials (connection string)
    DATABASE_URL: ""
    DATABASE_PASSWORD: ""

    # Redis URL (includes host, port, password, and TLS scheme)
    # Format: rediss://[username]:[password]@[host]:[port]
    REDIS_URL: ""

    # SMTP credentials
    SMTP_HOST: ""
    SMTP_USER: ""
    SMTP_PASSWORD: ""

    # API keys
    API_SECRET_KEY: ""

    # AWS credentials
    AWS_ACCESS_KEY_ID: ""
    AWS_SECRET_ACCESS_KEY: ""

    # OAuth/Auth providers
    NEXTAUTH_SECRET: ""
    NEXTAUTH_URL: ""

    GITHUB_CLIENT_ID: ""
    GITHUB_CLIENT_SECRET: ""

    GOOGLE_CLIENT_ID: ""
    GOOGLE_CLIENT_SECRET: ""

# Temporary filesystem volumes for Next.js writable directories
# These are required when readOnlyRootFilesystem is enabled
tmpfsVolumes:
  enabled: true
  mounts:
    - name: cache
      mountPath: /app/.next/cache
    - name: tmp
      mountPath: /tmp
    - name: nextjs-cache
      mountPath: /app/.next/cache/fetch-cache

# Persistence configuration (for user uploads, generated files, etc.)
persistence:
  enabled: false
  storageClass: ""
  accessMode: ReadWriteOnce
  size: 1Gi
  # Mount paths for persistent storage
  mounts:
    - name: storage
      mountPath: /app/public/uploads
      subPath: uploads

# External secrets (if using external secrets operator)
externalSecrets:
  enabled: false
  backendType: secretsManager
  region: us-east-1
  data: []

# Init containers (for setup tasks)
initContainers:
  # Verify build output exists
  verifyBuild:
    enabled: true
    command: ["sh", "-c", "ls -la /app/.next && echo 'Build verified'"]

# Additional init containers
extraInitContainers: []

# Sidecar containers (e.g., for log shipping, metrics)
sidecars: []

# Extra volumes
extraVolumes: []

# Extra volume mounts
extraVolumeMounts: []

# Extra environment variables
extraEnv: []

# Extra environment variables from ConfigMaps/Secrets
extraEnvFrom: []
