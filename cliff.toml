# ====================================================================================
# ğŸ“œ GIT-CLIFF CONFIGURATION
# Generates clean, structured changelogs based on Conventional Commits.
# ====================================================================================

[bump]
features_always_bump_minor = true
breaking_always_bump_major = true
initial_tag = "0.1.0"

[changelog]
header = """
# Changelog

All notable changes to this project will be documented in this file. See [conventional commits](https://www.conventionalcommits.org/) for commit guidelines.

"""
body = """
{% if version -%}
    {% set v = version | trim_start_matches(pat="v") | split(pat="-") | last -%}
    {% if previous.version -%}
## [{{ v }}](https://github.com/5ergiu/helm-charts/compare/{{ previous.version }}..{{ version }}) - {{ timestamp | date(format="%Y-%m-%d") }}
    {% else -%}
## [{{ v }}] - {{ timestamp | date(format="%Y-%m-%d") }}
    {% endif -%}
{% else -%}
## [unreleased]
{% endif -%}

{% for group, commits in commits | group_by(attribute="group") -%}
### {{ group | striptags | trim }}

{% for commit in commits -%}
{%- set first_line = commit.message | split(pat="\n") | first | trim -%}
{%- set has_issue = first_line is containing("[#") -%}
- {{ first_line }} \
([{{ commit.id | truncate(length=7, end=\"\") }}](https://github.com/5ergiu/helm-charts/commit/{{ commit.id }}))
{%- if has_issue %}
{%- set issue_num = first_line | split(pat="[#") | last | split(pat="]") | first %} in [#{{ issue_num }}](https://github.com/5ergiu/helm-charts/issues/{{ issue_num }}){% endif %}
{%- if commit.remote.pr_number %} via [#{{ commit.remote.pr_number }}](https://github.com/5ergiu/helm-charts/pull/{{ commit.remote.pr_number }}){% endif %}
{% endfor -%}

{% endfor -%}
"""
footer = """
<!-- generated by git-cliff -->
"""
trim = true

# Conventional commits parser
[git]
conventional_commits = true
filter_unconventional = true

# Grouping rules
commit_parsers = [
  # Breaking changes first
  { body = "BREAKING CHANGE", group = "ğŸ’¥ Breaking Changes" },

  # Standard conventional commits
  { message = "^feat",    group = "âœ¨ Features" },
  { message = "^fix",     group = "ğŸ› Fixes" },
  { message = "^docs",    group = "ğŸ“š Documentation" },
  { message = "^refactor",group = "â™»ï¸ Refactoring" },
  { message = "^perf",    group = "âš¡ Performance" },
  { message = "^test",    group = "ğŸ§ª Tests" },
  { message = "^chore",   group = "ğŸ”§ Chores" },
  { message = "^ci",      group = "ğŸ”„ CI/CD" },
  { message = "^build",   group = "ğŸ—ï¸ Build" },
  { message = "^style",   group = "ğŸ¨ Style" },

  # Helm-specific groups
  { message = "^chart",   group = "ğŸ“¦ Chart Updates" },
  { message = "^helm",    group = "â›µ Helm Infrastructure" }
]

# Sort newest commits first
sort_commits = "newest"

# GitHub remote configuration for automatic PR detection
[remote.github]
owner = "5ergiu"
repo = "helm-charts"
token = "$GITHUB_TOKEN"
