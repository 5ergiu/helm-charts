# ===================================================================
#  ğŸ”¥ Lefthook â€” Modern Git Hooks
# ===================================================================
# Fast, parallelized, and language-agnostic Git hook manager.
# This configuration enforces code quality, formatting, and 
# Conventional Commits standards before code leaves the
# local dev environment.
#
# Links:
# - Docs: https://lefthook.dev/
# - Conventional Commits: https://conventionalcommits.org
# ===================================================================


# ===================================================================
# ğŸ§¹ Pre-commit checks
# ===================================================================
pre-commit:
  parallel: true
  commands:

    # --- ğŸ§ª Helm Lint: Validate Chart syntax ---
    helm-lint:
      glob: "**/Chart.yaml"
      run: |
        for chart in $(echo "{staged_files}" | xargs -n1 dirname | sort -u); do
          echo "âœ¨ Linting Chart: $chart"
          helm lint "$chart"
        done

    # --- ğŸ—ï¸ Helm Template: Catch rendering errors ---
    helm-template:
      glob: "**/Chart.yaml"
      run: |
        for chart in $(echo "{staged_files}" | xargs -n1 dirname | sort -u); do
          echo "ğŸ“¦ Rendering Template: $chart"
          helm template "$chart" > /dev/null
        done

    # --- ğŸ” Gitleaks: Prevent secret leaks ---
    gitleaks:
      run: gitleaks protect --staged --verbose
      # Optional: custom message if the command fails for any reason
      fail_text: "ğŸ” Gitleaks failed! Make sure it is installed and no secrets are staged."

# ===================================================================
# ğŸ“ Enforce czg for ALL commits
# ===================================================================
prepare-commit-msg:
  commands:
    czg:
      interactive: true
      run: czg --hook
      skip:
        - merge
        - rebase
        - cherry-pick
        - revert
        - squash

# ===================================================================
# ğŸ§ª Validate Conventional Commits format
# ===================================================================
commit-msg:
  commands:
    validate-commit:
      run: ./.lefthook/validate-commit.sh {1}
