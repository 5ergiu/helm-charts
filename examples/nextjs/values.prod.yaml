# ============================================================================
# Production Values for Next.js Chart
# ============================================================================
# Enterprise-grade production configuration
# - High availability with autoscaling
# - TLS/HTTPS with cert-manager
# - Full security middlewares
# - Resource limits and requests
# - Monitoring and observability
#
# Prerequisites:
#   1. Traefik installed with CRD support
#   2. cert-manager installed for TLS certificates
#   3. Metrics server for HPA
#   4. Update all TODOs with your production values
# ============================================================================

image:
  repository: ghcr.io/5ergiu/nextjs  # TODO: Change to your production registry
  tag: latest  # TODO: Use specific version tags in production
  pullPolicy: Always

imagePullSecrets: []  # TODO: Add pull secrets if using private registry

# Web application - high availability
web:
  enabled: true
  replicaCount: 3

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault

  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true

  service:
    type: ClusterIP
    port: 80
    targetPort: 3000

  resources:
    limits:
      cpu: 2000m
      memory: 1Gi
    requests:
      cpu: 500m
      memory: 512Mi

  livenessProbe:
    enabled: true
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    enabled: true
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

  startupProbe:
    enabled: true
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 0
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 30

  # Horizontal Pod Autoscaler
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 20
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
          - type: Percent
            value: 50
            periodSeconds: 60
      scaleUp:
        stabilizationWindowSeconds: 0
        policies:
          - type: Percent
            value: 100
            periodSeconds: 15
          - type: Pods
            value: 2
            periodSeconds: 15
        selectPolicy: Max

  # Pod Disruption Budget for high availability
  pdb:
    enabled: true
    minAvailable: 2

  # Pod anti-affinity for spreading across nodes
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - nextjs
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                    - web
            topologyKey: kubernetes.io/hostname

# Ingress - using Traefik IngressRoute
ingress:
  enabled: false

ingressRoute:
  enabled: true
  entryPoints:
    - websecure

  # Apply all security middlewares
  middlewares:
    - headers
    - compress
    - ratelimit

  routes:
    - match: "Host(`app.example.com`)"  # TODO: Change to your domain
      kind: Rule
      priority: 10

  # TLS configuration with cert-manager
  tls:
    certResolver: letsencrypt-prod  # TODO: Configure cert-resolver in Traefik
    domains:
      - main: app.example.com  # TODO: Change to your domain
        sans:
          - www.app.example.com  # TODO: Add additional domains if needed

# Traefik Middlewares - full security suite
middleware:
  enabled: true

  # Rate limiting
  rateLimit:
    enabled: true
    average: 100
    burst: 200
    period: 1s

  # Security headers
  headers:
    enabled: true
    browserXssFilter: true
    contentTypeNosniff: true
    forceSTSHeader: true
    stsIncludeSubdomains: true
    stsPreload: true
    stsSeconds: 31536000
    customFrameOptionsValue: "SAMEORIGIN"
    customResponseHeaders:
      X-Powered-By: ""
      Server: ""

  # Response compression
  compress:
    enabled: true

  # HTTP to HTTPS redirect
  redirectScheme:
    enabled: true
    scheme: https
    permanent: true

# Next.js application configuration
nextjs:
  env:
    NODE_ENV: "production"
    # Add your production environment variables here
    # Examples:
    # NEXT_PUBLIC_API_URL: "https://api.example.com"
    # NEXT_PUBLIC_SITE_URL: "https://app.example.com"

  # Secrets should be provided via Kubernetes secrets or external secrets operator
  secrets: {}
    # Add your production secrets here
    # Examples:
    # DATABASE_URL: ""
    # API_SECRET_KEY: ""

# Tmpfs volumes for read-only filesystem
tmpfsVolumes:
  enabled: true
  mounts:
    - name: nextjs-cache
      mountPath: /app/.next/cache
    - name: tmp
      mountPath: /tmp

# No persistence needed for Next.js (stateless)
persistence:
  enabled: false
