# Production Values for Laravel Helm Chart
# Deploy with: helm install myapp ./charts/laravel -f charts/laravel/values.prod.yaml -n production --create-namespace

global:
  environment: production

# Image configuration - use production build target
image:
  repository: ghcr.io/5ergiu/laravel
  pullPolicy: IfNotPresent

imagePullSecrets:
  - name: ghcr-secret

# Web application - production configuration
web:
  enabled: true
  replicaCount: 3  # Multiple replicas for high availability

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  resources:
    limits:
      cpu: 2000m
      memory: 1Gi
    requests:
      cpu: 200m
      memory: 512Mi

  # Horizontal Pod Autoscaler
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 20
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  # Pod Disruption Budget
  pdb:
    enabled: true
    minAvailable: 2

# Worker configuration
worker:
  enabled: true
  replicaCount: 3
  command: ["php", "artisan", "horizon"]

  resources:
    limits:
      cpu: 1000m
      memory: 768Mi
    requests:
      cpu: 200m
      memory: 512Mi

  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 15
    targetCPUUtilizationPercentage: 70

# Scheduler
scheduler:
  enabled: true
  schedule: "* * * * *"

# Migration Job
migration:
  enabled: true

# Laravel configuration
laravel:
  env:
    APP_NAME: "Laravel Production"
    APP_ENV: "production"
    APP_DEBUG: "false"
    APP_URL: "https://app.example.com"

    LOG_CHANNEL: "stderr"
    LOG_LEVEL: "warning"

    DB_CONNECTION: "mysql"
    DB_HOST: "mysql.databases.svc.cluster.local"
    DB_PORT: "3306"
    DB_DATABASE: "laravel"

    CACHE_DRIVER: "redis"
    QUEUE_CONNECTION: "redis"
    SESSION_DRIVER: "redis"
    REDIS_HOST: "redis.databases.svc.cluster.local"
    REDIS_PORT: "6379"

  secrets:
    APP_KEY: ""  # Set via sealed secrets
    DB_USERNAME: "laravel"
    DB_PASSWORD: ""
    REDIS_PASSWORD: ""

# PHP Configuration - Production Optimized
php:
  env:
    # General Settings
    HEALTHCHECK_PATH: "/healthcheck"
    LOG_OUTPUT_LEVEL: "warn"
    SHOW_WELCOME_MESSAGE: "false"

    # PHP Runtime
    PHP_DISPLAY_ERRORS: "Off"
    PHP_DISPLAY_STARTUP_ERRORS: "Off"
    PHP_ERROR_REPORTING: "22527"
    PHP_MAX_EXECUTION_TIME: "120"
    PHP_MEMORY_LIMIT: "512M"
    PHP_UPLOAD_MAX_FILE_SIZE: "100M"
    PHP_POST_MAX_SIZE: "100M"

    # OPcache - Maximum Performance
    PHP_OPCACHE_ENABLE: "1"
    PHP_OPCACHE_VALIDATE_TIMESTAMPS: "0"  # Never check files
    PHP_OPCACHE_MEMORY_CONSUMPTION: "256"
    PHP_OPCACHE_MAX_ACCELERATED_FILES: "20000"
    PHP_OPCACHE_JIT: "tracing"
    PHP_OPCACHE_JIT_BUFFER_SIZE: "100"

    # PHP-FPM
    PHP_FPM_PM_CONTROL: "dynamic"
    PHP_FPM_PM_MAX_CHILDREN: "50"
    PHP_FPM_PM_START_SERVERS: "10"
    PHP_FPM_PM_MIN_SPARE_SERVERS: "5"
    PHP_FPM_PM_MAX_SPARE_SERVERS: "15"
    PHP_FPM_PM_MAX_REQUESTS: "1000"

    # Nginx
    NGINX_WEBROOT: "/var/www/html/public"
    NGINX_FASTCGI_BUFFERS: "16 16k"
    NGINX_FASTCGI_BUFFER_SIZE: "32k"
    NGINX_CLIENT_MAX_BODY_SIZE: "100M"

# Traefik IngressRoute
ingressRoute:
  enabled: true
  entryPoints:
    - websecure
  middlewares:
    - headers
    - compress
    - ratelimit
  routes:
    - match: "Host(`app.example.com`)"
      kind: Rule
  tls:
    certResolver: letsencrypt-prod

# Middleware
middleware:
  enabled: true
  rateLimit:
    enabled: true
    average: 100
    burst: 200
  headers:
    enabled: true
    forceSTSHeader: true
    stsSeconds: 31536000
  compress:
    enabled: true
  redirectScheme:
    enabled: true
    scheme: https

# Persistence
persistence:
  enabled: true
  storageClass: "fast-ssd"
  size: 50Gi

# Init containers
initContainers:
  cacheConfig:
    enabled: true
  cacheRoute:
    enabled: true
  cacheView:
    enabled: true
  storageLink:
    enabled: true
