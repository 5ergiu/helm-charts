# Development Values for Laravel Helm Chart (Local Kubernetes)
# Deploy with: helm install myapp-dev ./charts/laravel -f charts/laravel/values.dev.yaml -n development --create-namespace
#
# PREREQUISITES FOR LOCAL DEVELOPMENT:
# 1. Local Kubernetes cluster (Docker Desktop, Minikube, or Kind)
# 2. Traefik ingress controller: helm install traefik traefik/traefik -n traefik --create-namespace
# 3. MySQL: helm install mysql bitnami/mysql -n development
# 4. Redis: helm install redis bitnami/redis -n development
# 5. Add to /etc/hosts: 127.0.0.1 laravel.local

global:
  environment: development

# Image configuration - use development build target
image:
  repository: ghcr.io/5ergiu/laravel
  pullPolicy: Always
  tag: dev

# Web application - local development configuration
web:
  enabled: true
  replicaCount: 1  # Single replica for development

  strategy:
    type: Recreate  # Faster for development, no rolling updates

  # Minimal resources for local development
  resources:
    limits:
      cpu: 1000m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi

  # Service configuration for local access
  service:
    type: LoadBalancer  # Or NodePort for local access
    port: 80
    targetPort: 8080

  # Disable probes for faster startup in development
  livenessProbe:
    enabled: false
  readinessProbe:
    enabled: false
  startupProbe:
    enabled: false

  # Autoscaling - disabled for development
  autoscaling:
    enabled: false

  # PDB - disabled for development
  pdb:
    enabled: false

  # Security context - match your host user for volume mounts
  # Run: id -u && id -g to get your IDs
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000  # CHANGE THIS: id -u
    fsGroup: 1000    # CHANGE THIS: id -g

  # Container security context - relaxed for development with hostPath
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false  # Disabled for development with hostPath

# Worker configuration - minimal for development
worker:
  enabled: true
  replicaCount: 1
  command: ["php", "artisan", "horizon"]

  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

  autoscaling:
    enabled: false

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000  # CHANGE THIS: id -u
    fsGroup: 1000    # CHANGE THIS: id -g

  # Container security context - relaxed for development with hostPath
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false  # Disabled for development with hostPath

# Scheduler - enabled for development
scheduler:
  enabled: true
  schedule: "* * * * *"

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000  # CHANGE THIS: id -u

# Migration Job - enabled for initial setup
migration:
  enabled: true

# Laravel configuration - development settings
laravel:
  env:
    APP_NAME: "Laravel Dev"
    APP_ENV: "local"
    APP_DEBUG: "true"  # Enable debug mode
    APP_URL: "http://laravel.local"

    LOG_CHANNEL: "stderr"
    LOG_LEVEL: "debug"  # Verbose logging

    # Database - connect to local MySQL in k8s
    DB_CONNECTION: "mysql"
    DB_HOST: "mysql.development.svc.cluster.local"
    DB_PORT: "3306"
    DB_DATABASE: "laravel"

    # Cache/Session - connect to local Redis in k8s
    CACHE_DRIVER: "redis"
    QUEUE_CONNECTION: "redis"
    SESSION_DRIVER: "redis"
    SESSION_LIFETIME: "120"
    REDIS_HOST: "redis-master.development.svc.cluster.local"
    REDIS_PORT: "6379"

    # Filesystem - local storage
    FILESYSTEM_DISK: "local"

    # Mail - use Mailpit for local testing
    MAIL_MAILER: "smtp"
    MAIL_HOST: "mailpit.development.svc.cluster.local"
    MAIL_PORT: "1025"
    MAIL_ENCRYPTION: "null"
    MAIL_FROM_ADDRESS: "dev@laravel.local"
    MAIL_FROM_NAME: "Laravel Dev"

  # Secrets - NOT FOR PRODUCTION!
  secrets:
    APP_KEY: "base64:CHANGEME-local-dev-key-not-for-production"
    DB_USERNAME: "root"
    DB_PASSWORD: "password"
    REDIS_PASSWORD: ""

# PHP Configuration - Development Optimized
php:
  env:
    # General Settings
    HEALTHCHECK_PATH: "/healthcheck"
    LOG_OUTPUT_LEVEL: "debug"  # Verbose logging
    SHOW_WELCOME_MESSAGE: "true"  # Show startup info

    # PHP Runtime - Development
    PHP_DISPLAY_ERRORS: "On"  # Show errors
    PHP_DISPLAY_STARTUP_ERRORS: "On"
    PHP_ERROR_REPORTING: "32767"  # E_ALL - show all errors
    PHP_MAX_EXECUTION_TIME: "300"  # Longer timeout for debugging
    PHP_MEMORY_LIMIT: "512M"
    PHP_UPLOAD_MAX_FILE_SIZE: "100M"
    PHP_POST_MAX_SIZE: "100M"

    # OPcache - Disabled for hot reload
    PHP_OPCACHE_ENABLE: "0"  # Disabled - see code changes immediately
    PHP_OPCACHE_VALIDATE_TIMESTAMPS: "1"  # Check files if opcache enabled
    PHP_OPCACHE_MEMORY_CONSUMPTION: "128"

    # PHP-FPM - Minimal for development
    PHP_FPM_PM_CONTROL: "ondemand"  # Start processes on demand
    PHP_FPM_PM_MAX_CHILDREN: "10"
    PHP_FPM_PM_START_SERVERS: "2"
    PHP_FPM_PM_MIN_SPARE_SERVERS: "1"
    PHP_FPM_PM_MAX_SPARE_SERVERS: "3"
    PHP_FPM_PM_MAX_REQUESTS: "0"  # No restarts

    # Nginx - Development
    NGINX_WEBROOT: "/var/www/html/public"
    NGINX_FASTCGI_BUFFERS: "8 8k"
    NGINX_FASTCGI_BUFFER_SIZE: "8k"
    NGINX_CLIENT_MAX_BODY_SIZE: "100M"

# Ingress - local access
ingress:
  enabled: true
  className: traefik
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web  # HTTP only
  hosts:
    - host: laravel.local
      paths:
        - path: /
          pathType: Prefix
  tls: []  # No TLS for local development

# Traefik IngressRoute - disabled, using standard Ingress
ingressRoute:
  enabled: false

# Middleware - relaxed for development
middleware:
  enabled: true
  rateLimit:
    enabled: false  # No rate limiting in dev
  headers:
    enabled: true
    forceSTSHeader: false  # No HTTPS enforcement
  compress:
    enabled: true
  redirectScheme:
    enabled: false  # No HTTPS redirect

# Persistence - DISABLED when using hostPath for development
# When development.hostPath.enabled is true, all storage is managed via the hostPath mount
persistence:
  enabled: false

# Tmpfs volumes - DISABLED when using hostPath for development
# When development.hostPath.enabled is true, the entire /var/www/html directory
# is mounted from the host, so tmpfs volumes are not needed
tmpfsVolumes:
  enabled: false

# Init containers - enabled for proper setup
initContainers:
  cacheConfig:
    enabled: false  # Disable caching in dev for hot reload
  cacheRoute:
    enabled: false
  cacheView:
    enabled: false
  storageLink:
    enabled: true  # Keep storage link

# Development mode - ENABLE FOR HOT RELOAD
# This enables hostPath volume mounts and Bun sidecar for live code updates
development:
  enabled: true

  # HostPath volume configuration for hot reloading
  # IMPORTANT: Update 'path' to point to your Laravel application directory
  hostPath:
    enabled: true
    # CHANGE THIS: Absolute path to your Laravel app on your host machine
    # Example: /Users/yourname/projects/my-laravel-app
    path: "/path/to/your/laravel/app"  # UPDATE THIS!
    mountPath: /var/www/html

# Bun sidecar for Vite dev server (frontend hot module replacement)
# This runs alongside the Laravel container and shares the same hostPath volume
sidecars:
  - name: bun
    image: oven/bun:1
    imagePullPolicy: IfNotPresent
    workingDir: /var/www/html
    command: ["bun", "run", "dev"]
    ports:
      - name: vite
        containerPort: 5173
        protocol: TCP
    env:
      - name: VITE_HOST
        value: "0.0.0.0"
      - name: VITE_PORT
        value: "5173"
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi
    volumeMounts:
      - name: code
        mountPath: /var/www/html
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL

# Extra environment variables for development
extraEnv:
  - name: VITE_DEV_SERVER_URL
    value: "http://laravel.local:5173"  # Vite HMR endpoint
  - name: TELESCOPE_ENABLED
    value: "true"
  - name: DEBUGBAR_ENABLED
    value: "true"
