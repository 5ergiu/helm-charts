# ============================================================================
# CI Test Values for Laravel Chart
# ============================================================================
# Optimized for automated testing in CI/CD pipelines
# - Minimal resources
# - Fast startup
# - No external dependencies
# - SQLite for database
# ============================================================================

image:
  repository: ghcr.io/5ergiu/images/laravel
  tag: latest
  pullPolicy: Always

# Minimal replicas for CI
web:
  replicaCount: 1
  autoscaling:
    enabled: false

  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Disable probes for faster startup in CI
  livenessProbe:
    enabled: false
  readinessProbe:
    enabled: false
  startupProbe:
    enabled: false

  pdb:
    enabled: false

workers:
  default:
    enabled: true
    replicaCount: 1
    autoscaling:
      enabled: false

    image:
      repository: ghcr.io/5ergiu/images/laravel
      tag: cli
      pullPolicy: Always

    args: ["php", "artisan", "queue:work", "--tries=3"]

    resources:
      limits:
        cpu: 250m
        memory: 256Mi
      requests:
        cpu: 50m
        memory: 128Mi

    # Liveness probe for default worker - fails if can't connect to Redis/DB
    livenessProbe:
      enabled: true
      exec:
        command: ["healthcheck-queue"]
      initialDelaySeconds: 30
      periodSeconds: 60
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 3

    pdb:
      enabled: false

  horizon:
    enabled: true
    replicaCount: 1
    autoscaling:
      enabled: false

    image:
      repository: ghcr.io/5ergiu/images/laravel
      tag: cli
      pullPolicy: Always

    args: ["php", "artisan", "horizon"]

    resources:
      limits:
        cpu: 250m
        memory: 256Mi
      requests:
        cpu: 50m
        memory: 128Mi

    # Liveness probe for Horizon - fails if can't connect to Redis/DB
    livenessProbe:
      enabled: true
      exec:
        command: ["healthcheck-horizon"]
      initialDelaySeconds: 30
      periodSeconds: 60
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 3

    pdb:
      enabled: false

scheduler:
  enabled: true
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 25m
      memory: 64Mi

migration:
  enabled: true
  backoffLimit: 3
  resources:
    limits:
      cpu: 250m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

# Disable ingress/routing for CI
ingress:
  enabled: false

ingressRoute:
  enabled: false

middleware:
  enabled: false

# Laravel configuration for CI
laravel:
  env:
    APP_NAME: "Laravel CI"
    APP_ENV: "testing"
    APP_DEBUG: "true"
    APP_URL: "http://localhost"

    LOG_CHANNEL: "stderr"
    LOG_LEVEL: "debug"

    # Database configuration is handled via DATABASE_URL from CI environment (secrets)
    # DATABASE_URL takes precedence and includes: scheme, host, port, database, user, password
    # No need to set individual DB_* variables when using DATABASE_URL

    BROADCAST_DRIVER: "log"
    CACHE_DRIVER: "redis"
    FILESYSTEM_DISK: "local"
    QUEUE_CONNECTION: "redis"
    SESSION_DRIVER: "redis"

    # Redis configuration is handled via REDIS_URL from CI environment
    REDIS_CLIENT: "phpredis"

    MAIL_MAILER: "log"
    MAIL_HOST: "localhost"
    MAIL_PORT: "1025"
    MAIL_FROM_ADDRESS: "ci@example.com"
    MAIL_FROM_NAME: "Laravel CI"

  # Secrets will be provided by CI environment variables via --set flags
  # The test.sh script automatically injects secrets from environment variables
  # IMPORTANT: GitHub Secret names should be prefixed with chart name in uppercase
  # Example: LARAVEL_DATABASE_URL in GitHub â†’ DATABASE_URL in secrets.yaml.example
  secrets:
    APP_KEY: "base64:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
    DATABASE_URL: ""  # Injected from LARAVEL_DATABASE_URL
    REDIS_URL: ""  # Injected from LARAVEL_REDIS_URL

# PHP configuration for CI
php:
  env:
    PHP_DISPLAY_ERRORS: "On"
    PHP_DISPLAY_STARTUP_ERRORS: "On"
    PHP_OPCACHE_ENABLE: "0"  # Disable OPcache for CI
    PHP_MEMORY_LIMIT: "128M"

# Disable persistence for CI
persistence:
  enabled: false

# Tmpfs for testing
tmpfsVolumes:
  enabled: true
