# ============================================================================
# Local Test Values for Laravel Chart
# ============================================================================
# Optimized for local testing with Kind/K3d/Minikube
# - Minimal resources for laptop/desktop
# - Uses local service dependencies
# - No TLS (test with HTTP)
# - Suitable for integration testing
# ============================================================================

image:
  repository: ghcr.io/5ergiu/images/laravel
  tag: latest
  pullPolicy: Always

# Minimal replicas for local testing
web:
  replicaCount: 1
  autoscaling:
    enabled: false

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi

  service:
    type: ClusterIP
    port: 80
    targetPort: 8080

  pdb:
    enabled: false

workers:
  default:
    enabled: true
    replicaCount: 1
    autoscaling:
      enabled: false

    image:
      repository: ghcr.io/5ergiu/images/laravel
      tag: cli
      pullPolicy: Always

    args: ["php", "artisan", "queue:work"]

    resources:
      limits:
        cpu: 250m
        memory: 512Mi
      requests:
        cpu: 50m
        memory: 256Mi

    # Liveness probe for default worker - fails if can't connect to Redis/DB
    livenessProbe:
      enabled: true
      exec:
        command: ["healthcheck-queue"]
      initialDelaySeconds: 30
      periodSeconds: 60
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 3

    pdb:
      enabled: false

  horizon:
    enabled: true
    replicaCount: 1
    autoscaling:
      enabled: false

    image:
      repository: ghcr.io/5ergiu/images/laravel
      tag: cli
      pullPolicy: Always

    args: ["php", "artisan", "horizon"]

    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi

    # Liveness probe for Horizon - fails if can't connect to Redis/DB
    livenessProbe:
      enabled: true
      exec:
        command: ["healthcheck-horizon"]
      initialDelaySeconds: 30
      periodSeconds: 60
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 3

    pdb:
      enabled: false

scheduler:
  enabled: true

migration:
  enabled: true

# Ingress for local testing (no TLS)
ingress:
  enabled: false

ingressRoute:
  enabled: true
  entryPoints:
    - web  # HTTP only
  middlewares: []  # Minimal middlewares for testing
  routes:
    - match: "Host(`laravel.local`)"
      kind: Rule
      priority: 10
  tls: {}  # No TLS for local testing

middleware:
  enabled: false

# Laravel configuration for local testing
laravel:
  env:
    APP_NAME: "Laravel Test"
    APP_ENV: "local"
    APP_DEBUG: "true"
    APP_URL: "http://laravel.local"

    LOG_CHANNEL: "stderr"
    LOG_LEVEL: "debug"

    # Database and Redis configured via DATABASE_URL and REDIS_URL in secrets.yaml
    BROADCAST_DRIVER: "log"
    CACHE_DRIVER: "redis"
    FILESYSTEM_DISK: "local"
    QUEUE_CONNECTION: "redis"
    SESSION_DRIVER: "redis"
    SESSION_LIFETIME: "120"

    REDIS_CLIENT: "phpredis"

    MAIL_MAILER: "log"
    MAIL_FROM_ADDRESS: "test@laravel.local"
    MAIL_FROM_NAME: "Laravel Test"

  # Secrets should be provided via secrets.yaml (gitignored)
  secrets:
    APP_KEY: ""
    DATABASE_URL: ""
    REDIS_URL: ""
    AWS_ACCESS_KEY_ID: ""
    AWS_SECRET_ACCESS_KEY: ""
    MAIL_USERNAME: ""
    MAIL_PASSWORD: ""
    PUSHER_APP_ID: ""
    PUSHER_APP_KEY: ""
    PUSHER_APP_SECRET: ""

# PHP configuration for local testing
php:
  env:
    PHP_DISPLAY_ERRORS: "On"
    PHP_DISPLAY_STARTUP_ERRORS: "On"
    PHP_ERROR_REPORTING: "32767"  # E_ALL
    PHP_OPCACHE_ENABLE: "0"  # Disable OPcache for testing
    PHP_MEMORY_LIMIT: "256M"

# Tmpfs for testing
tmpfsVolumes:
  enabled: true

# No persistence for testing
persistence:
  enabled: false
