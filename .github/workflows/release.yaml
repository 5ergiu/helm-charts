name: üöÄ Release Charts

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip actual release)'
        required: false
        type: boolean
        default: false
      chart:
        description: 'Chart to release: "all" or specific chart name (e.g., laravel, nextjs)'
        required: true
        type: string
        default: 'all'

concurrency:
  group: release
  cancel-in-progress: true

jobs:
  resolve-charts:
    name: üìã Resolve Charts to Release
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    permissions:
      contents: read
    outputs:
      charts: ${{ steps.set-charts.outputs.charts }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: üìã Resolve charts to release
        id: set-charts
        run: |
          # Default to "all" if no input is provided (e.g., triggered by push)
          CHART_INPUT="${{ inputs.chart }}"
          if [ -z "$CHART_INPUT" ]; then
            CHART_INPUT="all"
          fi

          if [ "$CHART_INPUT" = "all" ]; then
            echo "Releasing all charts..."
            all_charts=$(for dir in charts/*/; do echo "${dir%/}"; done | jq -R . | jq -s -c .)
            echo "charts=$all_charts" >> $GITHUB_OUTPUT
            echo "Charts to release: $all_charts"
          else
            CHART_PATH="charts/$CHART_INPUT"
            echo "Releasing specific chart: $CHART_INPUT"
            json=$(echo "[\"$CHART_PATH\"]" | jq -c .)
            echo "charts=$json" >> $GITHUB_OUTPUT
          fi

  build:
    name: üî® Build Chart Artifacts
    needs:
      - resolve-charts
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üîß Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: üíø Install git-cliff
        uses: taiki-e/install-action@git-cliff

      - name: ‚éà Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: v4.0.1

      - name: üîå Install helm-schema plugin
        run: |
          if ! helm plugin list | grep -q "schema"; then
            helm plugin install https://github.com/losisin/helm-values-schema-json.git --version v2.3.1 --verify=false
          fi

      - name: üõ†Ô∏è Generate artifacts for all changed charts
        run: |
          charts='${{ needs.resolve-charts.outputs.charts }}'
          echo "Processing charts: $charts"

          # Convert JSON array to bash array
          chart_list=$(echo "$charts" | jq -r '.[]')

          for chart in $chart_list; do
            echo "=========================================="
            echo "Processing chart: $chart"
            echo "=========================================="

            chart_name=$(basename "$chart")

            # Generate schema
            echo "‚öôÔ∏è Generating schema for $chart_name..."
            helm schema -f "$chart/values.yaml" -o "$chart/values.schema.json" --draft 7

            # Check if version bump is needed
            echo "üîç Checking if version bump is needed for $chart_name..."
            current_version=$(yq eval '.version' "$chart/Chart.yaml")
            bumped=$(git cliff --config cliff.toml --bumped-version --include-path "$chart/*" --tag-pattern "${chart_name}-*")
            # Extract just the semantic version (remove chart name prefix and 'v' prefix)
            # Handles: chart_name-v0.2.0 -> 0.2.0, chart_name-0.2.0 -> 0.2.0, or just v0.2.0 -> 0.2.0
            new_version=$(echo "$bumped" | sed -e "s|^${chart_name}-v||" -e "s|^${chart_name}-||" -e "s|^v||")

            if [ "$new_version" = "$current_version" ]; then
              echo "‚è≠Ô∏è  No version bump needed (current: $current_version), skipping changelog generation"
            else
              echo "üîº Bumping chart version: $current_version ‚Üí $new_version"
              yq -i ".version = \"$new_version\"" "$chart/Chart.yaml"

              # Generate changelog with new version
              echo "üìù Generating changelog for $chart_name..."
              git-cliff --bump --config cliff.toml --prepend "$chart/CHANGELOG.md" --include-path "$chart/*" --tag-pattern "${chart_name}-*"

              # Generate ArtifactHub annotations
              echo "üìù Generating ArtifactHub annotations for $chart_name..."
              git-cliff --config cliff-artifacthub.toml --unreleased --strip all --output changes.yaml --include-path "$chart/*" --tag-pattern "${chart_name}-*" 2>/dev/null
              # Remove leading empty line from changes.yaml
              tail -n +2 changes.yaml > changes-trimmed.yaml
              yq eval -i '.annotations."artifacthub.io/changes" = load_str("changes-trimmed.yaml")' "$chart/Chart.yaml"
              rm -f changes.yaml changes-trimmed.yaml

              echo "‚úÖ Chart $chart_name updated to version $new_version"
            fi
          done

      - name: üíæ Commit and push changes
        run: |
          git add charts/*/Chart.yaml charts/*/CHANGELOG.md charts/*/values.schema.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update chart artifacts"
            git push origin main
            echo "‚úÖ Artifacts committed and pushed to main"
          fi

  release:
    name: üöÄ Release Charts
    runs-on: ubuntu-latest
    needs: build
    if: inputs.dry_run != 'true'
    permissions:
      contents: write
    outputs:
      changed_charts: ${{ steps.chart-releaser.outputs.changed_charts }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          ref: main

      - name: üîß Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: üì¶ Update chart dependencies
        run: |
          set -euo pipefail
          echo "Updating dependencies for all charts..."
          for chart_dir in charts/*; do
            if [ -f "$chart_dir/Chart.yaml" ]; then
              echo "Processing $chart_dir..."
              if grep -q "^dependencies:" "$chart_dir/Chart.yaml"; then
                echo "  ‚Üí Updating dependencies for $chart_dir"
                helm dependency update "$chart_dir"
              else
                echo "  ‚Üí No dependencies found, skipping"
              fi
            fi
          done

      - name: üöÄ Run chart-releaser
        id: chart-releaser
        uses: helm/chart-releaser-action@cae68fefc6b5f367a0275617c9f83181ba54714f # v1.7.0
        with:
          skip_existing: true
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

  oci-upload:
    name: üì§ Upload Charts to OCI
    needs:
      - resolve-charts
      - release
    if: needs.release.outputs.changed_charts != ''
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          ref: main

      - name: ‚éà Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: v4.0.1

      - name: üîê Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: üîê Login to registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üì§ Push and sign charts
        env:
          COSIGN_KEY: ${{ secrets.COSIGN_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          charts='${{ needs.resolve-charts.outputs.charts }}'
          echo "Processing charts: $charts"

          # Get repository owner in lowercase
          REPO_OWNER=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')
          echo "Repository owner: $REPO_OWNER"

          # Retry function for registry operations
          retry() {
            local max_attempts=3
            local attempt=1
            local delay=5
            while [ $attempt -le $max_attempts ]; do
              if "$@"; then return 0; fi
              echo "‚ö†Ô∏è Attempt $attempt/$max_attempts failed. Retrying in ${delay}s..."
              sleep $delay
              delay=$((delay * 2))
              attempt=$((attempt + 1))
            done
            echo "‚ùå ERROR: Failed after $max_attempts attempts"
            return 1
          }

          # Login to registry
          echo "üîê Logging into ghcr.io..."
          retry helm registry login --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} ghcr.io

          # Convert JSON array to bash array
          chart_list=$(echo "$charts" | jq -r '.[]')

          # Initialize summary
          echo "## üì¶ Chart Upload Summary" >> $GITHUB_STEP_SUMMARY

          for chart in $chart_list; do
            echo "=========================================="
            echo "Processing chart: $chart"
            echo "=========================================="

            CHART_NAME=$(basename "$chart")
            CHART_VERSION=$(yq eval '.version' "$chart/Chart.yaml")

            echo "Chart: $CHART_NAME"
            echo "Version: $CHART_VERSION"

            # Default to chart-releaser output location
            PACKAGE_FILE=".cr-release-packages/${CHART_NAME}-${CHART_VERSION}.tgz"

            # Verify package exists
            if [ ! -f "$PACKAGE_FILE" ]; then
              echo "ERROR: Package file not found at $PACKAGE_FILE"
              echo "Attempting to package chart..."
              mkdir -p .helm-packages
              helm package "$chart" -d .helm-packages
              PACKAGE_FILE=".helm-packages/${CHART_NAME}-${CHART_VERSION}.tgz"
            fi

            # Push chart to OCI registry
            echo "üì¶ Uploading Helm chart $CHART_NAME-$CHART_VERSION.tgz to ghcr.io..."
            if retry helm push "$PACKAGE_FILE" "oci://ghcr.io/${REPO_OWNER}/helm-charts" 2>&1 | tee push-output.log; then
              DIGEST=$(grep -oP 'Digest:\s*\K(sha256:[a-f0-9]+)' push-output.log || echo "")
              if [ -z "$DIGEST" ]; then
                echo "ERROR: Failed to extract digest"
                cat push-output.log
                exit 1
              fi
              echo "‚úÖ Successfully pushed $CHART_NAME:$CHART_VERSION"
              echo "üìç Digest: $DIGEST"

              # Sign chart with Cosign
              echo "üîê Signing chart $CHART_NAME:$CHART_VERSION with Cosign..."
              if retry cosign sign -y --upload=true --key env://COSIGN_KEY "ghcr.io/${REPO_OWNER}/helm-charts/${CHART_NAME}:${CHART_VERSION}@$DIGEST"; then
                echo "‚úÖ Successfully signed $CHART_NAME:$CHART_VERSION"

                # Add to summary
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### $CHART_NAME" >> $GITHUB_STEP_SUMMARY
                echo "- **Version**: $CHART_VERSION" >> $GITHUB_STEP_SUMMARY
                echo "- **Registry**: \`ghcr.io/${REPO_OWNER}/helm-charts\`" >> $GITHUB_STEP_SUMMARY
                echo "- **Digest**: \`$DIGEST\`" >> $GITHUB_STEP_SUMMARY
                echo "- **Signing**: ‚úÖ Enabled" >> $GITHUB_STEP_SUMMARY
              else
                echo "‚ö†Ô∏è Failed to sign $CHART_NAME:$CHART_VERSION (chart uploaded but not signed)"
                exit 1
              fi
            else
              echo "‚ùå Failed to push chart $CHART_NAME:$CHART_VERSION"
              exit 1
            fi
          done

          echo "=========================================="
          echo "‚úÖ All charts processed successfully"
          echo "=========================================="
