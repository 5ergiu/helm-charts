name: ğŸš€ Release Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip actual release)'
        required: false
        type: boolean
        default: false
      chart:
        description: 'Specific chart to release (optional, e.g., charts/my-chart)'
        required: false
        type: string

concurrency:
  group: release
  cancel-in-progress: true

permissions:
  contents: write
  packages: write

jobs:
  changed-charts:
    name: ğŸ” Find Changed Charts
    # Skip if triggered by github-actions bot
    if: github.actor != 'github-actions[bot]' && github.event.inputs.chart == ''
    uses: ./.github/workflows/changed-charts.yaml

  resolve-charts:
    name: ğŸ“‹ Resolve Charts to Release
    needs: 
      - changed-charts
    if: always() && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.set-charts.outputs.charts }}
    steps:
      - name: ğŸ“‹ Resolve charts to release
        id: set-charts
        run: |
          if [ -n "${{ github.event.inputs.chart }}" ]; then
            # Specific chart provided via input
            echo "Using specified chart: ${{ github.event.inputs.chart }}"
            json=$(echo '["${{ github.event.inputs.chart }}"]' | jq -c .)
            echo "charts=$json" >> $GITHUB_OUTPUT
          else
            # Use detected charts (empty array if no changes)
            charts='${{ needs.changed-charts.outputs.charts }}'
            echo "charts=$charts" >> $GITHUB_OUTPUT
            echo "Charts to release: $charts"
          fi

  test-charts:
    name: ğŸ§ª Test Charts
    needs: resolve-charts
    if: needs.resolve-charts.outputs.charts != '[]'
    uses: ./.github/workflows/test-charts.yaml
    with:
      chart: ${{ github.event.inputs.chart }}

  build:
    name: ğŸ”¨ Build Chart Artifacts
    needs:
      - resolve-charts
      - test-charts
    runs-on: ubuntu-latest
    if: needs.resolve-charts.outputs.charts != '[]'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ’¿ Install git-cliff
        uses: taiki-e/install-action@git-cliff

      - name: âˆ Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: v4.0.1

      - name: ğŸ”Œ Install helm-schema plugin
        run: |
          if ! helm plugin list | grep -q "schema"; then
            helm plugin install https://github.com/losisin/helm-values-schema-json.git --version v1.9.2
          fi

      - name: ğŸ› ï¸ Generate artifacts for all changed charts
        run: |
          charts='${{ needs.resolve-charts.outputs.charts }}'
          echo "Processing charts: $charts"

          # Convert JSON array to bash array
          chart_list=$(echo "$charts" | jq -r '.[]')

          for chart in $chart_list; do
            echo "=========================================="
            echo "Processing chart: $chart"
            echo "=========================================="

            chart_name=$(basename "$chart")

            # Generate schema
            echo "âš™ï¸ Generating schema for $chart_name..."
            helm schema -input "$chart/values.yaml" -output "$chart/values.schema.json" -draft 7

            # Generate changelog
            echo "ğŸ“ Generating changelog for $chart_name..."
            git-cliff --verbose --bump --config cliff.toml --output "$chart/CHANGELOG.md" --include-path "$chart/*"

            # Generate ArtifactHub annotations
            echo "ğŸ“ Generating ArtifactHub annotations for $chart_name..."
            git-cliff --config cliff-artifacthub.toml --output changes.json --include-path "$chart/*"
            yq eval '.annotations."artifacthub.io/changes" += load("changes.json")' -i "$chart/Chart.yaml"
            rm -f changes.json

            # Bump chart version
            echo "ğŸ”¼ Bumping chart version for $chart_name..."
            bumped=$(git cliff --bumped-version)
            new_version=$(echo "$bumped" | cut -d'-' -f2-)
            yq -i ".version = \"$new_version\"" "$chart/Chart.yaml"
            echo "âœ… New version: $new_version"
          done

      - name: ğŸ’¾ Commit and push changes
        run: |
          git add charts/*/Chart.yaml charts/*/CHANGELOG.md charts/*/values.schema.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update chart artifacts"
            git push origin main
            echo "âœ… Artifacts committed and pushed to main"
          fi

  release:
    name: ğŸš€ Release Charts
    runs-on: ubuntu-latest
    needs:
      - resolve-charts
      - test-charts
      - build
    if: github.event.inputs.dry_run != 'true' && needs.resolve-charts.outputs.charts != '[]'
    outputs:
      changed_charts: ${{ steps.chart-releaser.outputs.changed_charts }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          ref: main

      - name: ğŸ“¦ Update chart dependencies
        run: |
          set -euo pipefail
          echo "Updating dependencies for all charts..."
          for chart_dir in charts/*; do
            if [ -f "$chart_dir/Chart.yaml" ]; then
              echo "Processing $chart_dir..."
              if grep -q "^dependencies:" "$chart_dir/Chart.yaml"; then
                echo "  â†’ Updating dependencies for $chart_dir"
                helm dependency update "$chart_dir"
              else
                echo "  â†’ No dependencies found, skipping"
              fi
            fi
          done

      - name: ğŸš€ Run chart-releaser
        id: chart-releaser
        uses: helm/chart-releaser-action@cae68fefc6b5f367a0275617c9f83181ba54714f # v1.7.0
        with:
          skip_existing: true
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

  upload-to-oci:
    name: ğŸ“¤ Upload to OCI Registry
    needs:
      - resolve-charts
      - release
    if: needs.release.outputs.changed_charts != ''
    strategy:
      matrix:
        chart: ${{ fromJSON(needs.resolve-charts.outputs.charts) }}
    uses: ./.github/workflows/oci-upload.yaml
    with:
      chart: ${{ matrix.chart }}
    secrets:
      COSIGN_KEY: ${{ secrets.COSIGN_KEY }}
      COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
      REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
