name: ðŸ·ï¸ Auto Label

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-label:
    name: Auto Label
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Label issues
        if: github.event_name == 'issues'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { issue } = context.payload;
            const body = issue.body || '';
            const labels = new Set();

            // Parse issue form field
            const parseField = (label) => {
              const match = body.match(new RegExp(`###\\s*${label}\\s*\\n\\s*\\n([^#]+)`, 'i'));
              return match?.[1].trim();
            };

            // Chart mapping
            const chartMap = {
              'Laravel': 'chart:laravel',
              'Next.js': 'chart:nextjs',
              'Multiple charts': 'multiple-charts'
            };

            // Detect affected chart
            const chart = parseField('ðŸ“¦ Affected Chart|ðŸ“¦ Target Chart');
            if (chart) {
              Object.entries(chartMap).forEach(([key, label]) => {
                if (chart.includes(key)) labels.add(label);
              });
            }

            // Priority mapping
            const priority = parseField('Priority');
            if (priority?.includes('Critical')) labels.add('priority:critical');
            if (priority?.includes('Important')) labels.add('priority:high');

            // Apply unique labels
            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                ...context.repo,
                issue_number: issue.number,
                labels: [...labels]
              });
            }

      - name: Label PRs
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { pull_request: pr } = context.payload;
            const labels = new Set();

            // Get changed files
            const { data: files } = await github.rest.pulls.listFiles({
              ...context.repo,
              pull_number: pr.number
            });

            const paths = files.map(f => f.filename);

            // Detect charts
            const charts = new Set(
              paths
                .filter(p => p.startsWith('charts/'))
                .map(p => p.split('/')[1])
            );

            if (charts.has('laravel')) labels.add('chart:laravel');
            if (charts.has('nextjs')) labels.add('chart:nextjs');
            if (charts.size > 1) labels.add('multiple-charts');

            // File-based labels
            const filePatterns = {
              '/templates/': 'area:templates',
              'values.yaml': 'area:configuration',
              '/tests/': 'area:testing',
              '.md': 'documentation',
              '.github/workflows/': 'area:ci-cd'
            };

            Object.entries(filePatterns).forEach(([pattern, label]) => {
              if (paths.some(p => p.includes(pattern))) labels.add(label);
            });

            // Apply labels
            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                ...context.repo,
                issue_number: pr.number,
                labels: [...labels]
              });
            }

      - name: Welcome first-time contributors
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { pull_request: pr } = context.payload;

            const { data: prs } = await github.rest.pulls.list({
              ...context.repo,
              state: 'all',
              creator: pr.user.login
            });

            if (prs.length === 1) {
              const message = [
                `## ðŸ‘‹ Welcome @${pr.user.login}!`,
                ``,
                `Thank you for your first contribution! ðŸŽ‰`,
                ``,
                `**What's Next?**`,
                `- âœ… CI/CD will run automated tests`,
                `- ðŸ‘€ A maintainer will review your changes`,
                `- ðŸ’¬ Feel free to ask questions`,
                ``,
                `**Resources:** [Contributing](../blob/main/CONTRIBUTING.md) Â· [Testing](../blob/main/TESTING.md) Â· [Signing](../blob/main/COSIGN.md)`
              ].join('\n');

              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: pr.number,
                body: message
              });

              await github.rest.issues.addLabels({
                ...context.repo,
                issue_number: pr.number,
                labels: ['first-time-contributor']
              });
            }
