name: âœ… Pull Request Validation

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  lint-test:
    name: Lint and Test Charts
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      changed: ${{ steps.list-changed.outputs.changed }}
      changedCharts: ${{ steps.list-changed.outputs.changedCharts }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: âŽˆ Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: v4.0.1

      - name: ðŸ Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.14'

      - name: ðŸ”§ Set up chart-testing
        uses: helm/chart-testing-action@6ec842c01de15ebb84c8627d2744a0c2f2755c9f # v2.8.0

      - name: ðŸ” Get changed charts
        id: list-changed
        run: |
          changed=$(ct list-changed --target-branch ${{ github.event.repository.default_branch }})
          if [[ -n "$changed" ]]; then
            echo "Changed charts:"
            echo "$changed"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo 'changedCharts<<EOF' >> $GITHUB_OUTPUT
            echo $changed >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT
          else
            echo "No chart changes detected"
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ’¾ Cache Helm plugins
        if: steps.list-changed.outputs.changed == 'true'
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.local/share/helm/plugins
          key: ${{ runner.os }}-helm-plugins-${{ hashFiles('**/plugin.yaml') }}
          restore-keys: |
            ${{ runner.os }}-helm-plugins-

      - name: ðŸ”Œ Installing plugin helm-unittest
        if: steps.list-changed.outputs.changed == 'true'
        run: |
          if ! helm plugin list | grep -q unittest; then
            helm plugin install https://github.com/helm-unittest/helm-unittest
          else
            echo "helm-unittest plugin already installed"
          fi

      - name: ðŸ“Š Run chart-testing (lint)
        if: steps.list-changed.outputs.changed == 'true'
        run: |
          ct lint --target-branch ${{ github.event.repository.default_branch }} \
            --validate-maintainers=false \
            --check-version-increment=true

      - name: ðŸ§ª Run helm-unittest
        if: steps.list-changed.outputs.changed == 'true'
        run: |
          for chart in ${{ steps.list-changed.outputs.changedCharts }}; do
            echo "Testing $chart..."
            if [ -d "$chart/tests" ]; then
              helm unittest $chart
            else
              echo "No tests found for $chart, skipping..."
            fi
          done

      - name: ðŸ’¬ Comment PR
        if: steps.list-changed.outputs.changed == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const charts = `${{ steps.list-changed.outputs.changedCharts }}`.split('\n').filter(c => c);
            const body = `## ðŸ“¦ Chart Validation Report
            
            ### Changed Charts
            ${charts.map(c => `- âœ… \`${c}\``).join('\n')}
            
            ### Validation Steps
            - âœ… Helm linting passed
            - âœ… Unit tests passed
            - âœ… Template rendering successful
            
            > Ready for integration testing`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  integration-test:
    name: Integration Test in Kind
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [lint-test]
    if: needs.lint-test.outputs.changed == 'true'
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: âŽˆ Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: v4.0.1

      - name: ðŸ”§ Set up chart-testing
        uses: helm/chart-testing-action@6ec842c01de15ebb84c8627d2744a0c2f2755c9f # v2.8.0

      - name: ðŸ³ Create kind cluster
        uses: helm/kind-action@92086f6be054225fa813e0a4b13787fc9088faab # v1.13.0
        with:
          cluster_name: helm-chart-test
          wait: 300s

      - name: âœ… Run chart-testing (install)
        run: |
          ct install --target-branch ${{ github.event.repository.default_branch }} \
            --debug

      - name: ðŸ“Š Show cluster state
        if: always()
        run: |
          echo "=== All Resources ==="
          kubectl get all -A
          
          echo -e "\n=== Events ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -20

      - name: ðŸ’¬ Comment integration results
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const charts = `${{ needs.lint-test.outputs.changedCharts }}`.split('\n').filter(c => c);
            const status = '${{ job.status }}' === 'success' ? 'âœ…' : 'âŒ';
            const body = `## ðŸ§ª Integration Test Report
            
            ${status} Integration tests ${{ job.status }}
            
            ### Tested Charts
            ${charts.map(c => `- ${status} \`${c}\``).join('\n')}
            
            ### Environment
            - Kubernetes: v1.34.0
            - Helm: v4.0.1
            - Runtime: kind cluster
            
            <details>
            <summary>View test details</summary>
            
            Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for full logs.
            </details>`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
