name: üîê Check Signed Commits

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  check-signed-commits:
    name: Verify Commit Signatures
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: üîç Check commit signatures
        id: check-signatures
        run: |
          echo "Checking commit signatures for PR commits..."
          
          # Get the list of commits in this PR
          COMMITS=$(git log --format="%H" origin/${{ github.event.pull_request.base.ref }}..${{ github.event.pull_request.head.sha }})
          
          UNSIGNED_COMMITS=""
          TOTAL_COMMITS=0
          SIGNED_COMMITS=0
          
          for commit in $COMMITS; do
            TOTAL_COMMITS=$((TOTAL_COMMITS + 1))
            
            # Check if commit is signed (GPG or SSH)
            if git verify-commit $commit 2>/dev/null; then
              SIGNED_COMMITS=$((SIGNED_COMMITS + 1))
              echo "‚úì Signed: $commit"
            else
              echo "‚úó Unsigned: $commit"
              UNSIGNED_COMMITS="$UNSIGNED_COMMITS $commit"
            fi
          done
          
          echo "total_commits=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
          echo "signed_commits=$SIGNED_COMMITS" >> $GITHUB_OUTPUT
          echo "unsigned_commits=$UNSIGNED_COMMITS" >> $GITHUB_OUTPUT
          
          if [ $SIGNED_COMMITS -lt $TOTAL_COMMITS ]; then
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const totalCommits = parseInt('${{ steps.check-signatures.outputs.total_commits }}');
            const signedCommits = parseInt('${{ steps.check-signatures.outputs.signed_commits }}');
            const unsignedCommits = '${{ steps.check-signatures.outputs.unsigned_commits }}'.trim();
            const status = '${{ steps.check-signatures.outputs.status }}';
            
            let body = '## üîê Commit Signature Check\n\n';
            
            if (status === 'success') {
              body += `‚úÖ All commits are signed (${signedCommits}/${totalCommits})\n\n`;
              body += 'Great job maintaining security best practices!';
            } else {
              body += `‚ö†Ô∏è  Some commits are not signed (${signedCommits}/${totalCommits} signed)\n\n`;
              body += '### Unsigned Commits\n';
              body += unsignedCommits.split(' ').filter(c => c).map(c => `- \`${c.substring(0, 7)}\``).join('\n');
              body += '\n\n### How to Sign Commits\n\n';
              body += '**Using SSH (Recommended)**\n';
              body += '```bash\n';
              body += 'git config gpg.format ssh\n';
              body += 'git config user.signingkey ~/.ssh/id_ed25519.pub\n';
              body += 'git config commit.gpgsign true\n';
              body += '```\n\n';
              body += '**Using GPG**\n';
              body += '```bash\n';
              body += 'git config user.signingkey YOUR_GPG_KEY_ID\n';
              body += 'git config commit.gpgsign true\n';
              body += '```\n\n';
              body += '**Sign Existing Commits**\n';
              body += '```bash\n';
              body += '# Rebase and sign\n';
              body += 'git rebase --exec "git commit --amend --no-edit -S" -i origin/main\n';
              body += 'git push --force-with-lease\n';
              body += '```\n\n';
              body += 'Learn more: [GitHub Docs on Commit Signing](https://docs.github.com/en/authentication/managing-commit-signature-verification)';
            }
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üîê Commit Signature Check')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
