name: üìù Post-Merge Changelog Update

on:
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'charts/**'
  workflow_dispatch:
    inputs:
      update_all_charts:
        description: 'Update all charts (not just changed ones)'
        required: false
        type: boolean
        default: false
      clean_start:
        description: 'Delete existing CHANGELOG.md files and start fresh'
        required: false
        type: boolean
        default: false
      custom_message:
        description: 'Custom changelog message (optional)'
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  update-changelog:
    name: Update Changelogs
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.actor != 'github-actions[bot]'
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üîß Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: üè∑Ô∏è Fetch all tags
        run: |
          git fetch --tags --force
          echo "üìã Recent tags:"
          git tag -l | tail -10

      - name: üì¶ Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: üîç Determine charts to update
        id: charts-to-update
        run: |
          # For manual trigger with update_all_charts enabled
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.update_all_charts }}" = "true" ]; then
            echo "üéØ Manual trigger: updating all charts"
            all_charts=$(find charts -mindepth 1 -maxdepth 1 -type d | sed 's|^charts/||' | tr '\n' ' ')
            echo "All charts: $all_charts"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "changedCharts=$all_charts" >> $GITHUB_OUTPUT
            echo "update_mode=all" >> $GITHUB_OUTPUT
          
          # For manual trigger without update_all_charts
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üîç Manual trigger: finding changed charts from last commit"
            BEFORE_SHA=$(git rev-parse HEAD~1)
            changed_files=$(git diff --name-only "${BEFORE_SHA}" HEAD -- 'charts/**' || echo "")
            
            if [[ -n "$changed_files" ]]; then
              changed_charts=$(echo "$changed_files" | grep '^charts/' | cut -d/ -f1-2 | sort -u | tr '\n' ' ')
              if [[ -n "$changed_charts" ]]; then
                echo "‚úÖ Changed charts: $changed_charts"
                echo "changed=true" >> $GITHUB_OUTPUT
                echo "changedCharts=${changed_charts}" >> $GITHUB_OUTPUT
                echo "update_mode=changed" >> $GITHUB_OUTPUT
              else
                echo "‚ÑπÔ∏è  No chart changes detected in last commit"
                echo "changed=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "‚ÑπÔ∏è  No chart changes detected in last commit"
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          
          # For push event
          else
            echo "üîç Push event: finding changed charts from merge commit"
            BEFORE_SHA="${{ github.event.before }}"
            changed_files=$(git diff --name-only "${BEFORE_SHA}" HEAD -- 'charts/**' || echo "")

            if [[ -n "$changed_files" ]]; then
              changed_charts=$(echo "$changed_files" | grep '^charts/' | cut -d/ -f1-2 | sort -u | tr '\n' ' ')
              if [[ -n "$changed_charts" ]]; then
                echo "‚úÖ Changed charts: $changed_charts"
                echo "changed=true" >> $GITHUB_OUTPUT
                echo "changedCharts=${changed_charts}" >> $GITHUB_OUTPUT
                echo "update_mode=changed" >> $GITHUB_OUTPUT
              else
                echo "‚ÑπÔ∏è  No chart changes detected"
                echo "changed=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "‚ÑπÔ∏è  No chart changes detected"
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: üßπ Clean start - Delete existing CHANGELOG.md files
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.clean_start == 'true' && steps.charts-to-update.outputs.changed == 'true'
        run: |
          echo "üßπ Clean start enabled - deleting existing CHANGELOG.md files"
          CHANGED_CHARTS="${{ steps.charts-to-update.outputs.changedCharts }}"
          
          for chart_directory in $CHANGED_CHARTS; do
            CHART_NAME=${chart_directory#charts/}
            CHANGELOG_FILE="charts/${CHART_NAME}/CHANGELOG.md"
            
            if [ -f "$CHANGELOG_FILE" ]; then
              echo "üóëÔ∏è  Deleting $CHANGELOG_FILE"
              rm "$CHANGELOG_FILE"
            else
              echo "‚ÑπÔ∏è  No CHANGELOG.md found at $CHANGELOG_FILE"
            fi
          done
          
          # Commit the deletions if any files were removed
          if git status --porcelain | grep -q 'CHANGELOG.md'; then
            echo "‚úÖ CHANGELOG.md files deleted successfully"
            git add charts/*/CHANGELOG.md
            git commit -m "chore: remove existing CHANGELOG.md files for clean start" \
              -m "Signed-off-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
            echo "clean_start_completed=true" >> $GITHUB_ENV
          else
            echo "‚ÑπÔ∏è  No CHANGELOG.md files to delete"
            echo "clean_start_completed=false" >> $GITHUB_ENV
          fi

      - name: üìã Get PR information for push events
        id: pr-info-push
        if: github.event_name == 'push' && steps.charts-to-update.outputs.changed == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commit = context.payload.head_commit;
            const commitSha = commit.id;

            // Find the PR that was merged
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commitSha
            });

            const mergedPR = prs.find(pr => pr.merged_at);

            if (mergedPR) {
              core.setOutput('pr_number', mergedPR.number);
              core.setOutput('pr_title', mergedPR.title);
              core.setOutput('pr_url', mergedPR.html_url);
              console.log(`Found merged PR #${mergedPR.number}: ${mergedPR.title}`);
            } else {
              console.log('No merged PR found for this commit');
              core.setOutput('pr_number', '');
              core.setOutput('pr_title', commit.message.split('\n')[0]);
              core.setOutput('pr_url', '');
            }

      - name: üìù Set manual trigger info
        id: manual-info
        if: github.event_name == 'workflow_dispatch' && steps.charts-to-update.outputs.changed == 'true'
        run: |
          if [ -n "${{ github.event.inputs.custom_message }}" ]; then
            PR_TITLE="${{ github.event.inputs.custom_message }}"
          else
            if [ "${{ github.event.inputs.clean_start }}" = "true" ]; then
              PR_TITLE="Manual changelog update with clean start"
            else
              PR_TITLE="Manual changelog update triggered via workflow_dispatch"
            fi
          fi
          
          echo "pr_number=manual" >> $GITHUB_OUTPUT
          echo "pr_title=${PR_TITLE}" >> $GITHUB_OUTPUT
          echo "pr_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: üî® Generate changelog
        id: generate-changelog
        if: steps.charts-to-update.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          GITHUB_REPOSITORY: "${{ github.repository }}"
          GITHUB_REPOSITORY_URL: "${{ github.server_url }}/${{ github.repository }}"
          PR_NUMBER: ${{ github.event_name == 'push' && steps.pr-info-push.outputs.pr_number || steps.manual-info.outputs.pr_number }}
          PR_TITLE: ${{ github.event_name == 'push' && steps.pr-info-push.outputs.pr_title || steps.manual-info.outputs.pr_title }}
          PR_URL: ${{ github.event_name == 'push' && steps.pr-info-push.outputs.pr_url || steps.manual-info.outputs.pr_url }}
          UPDATE_MODE: ${{ steps.charts-to-update.outputs.update_mode }}
          CLEAN_START: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.clean_start || 'false' }}
        run: |
          set -e

          CHANGED_CHARTS="${{ steps.charts-to-update.outputs.changedCharts }}"
          
          echo "üìä Update mode: $UPDATE_MODE"
          echo "üßπ Clean start: $CLEAN_START"
          echo "üì¶ Processing charts: $CHANGED_CHARTS"
          echo ""

          # Process each chart individually
          for chart_directory in $CHANGED_CHARTS; do
            CHART_NAME=${chart_directory#charts/}
            echo "üî® Processing chart: $CHART_NAME"
            
            # Run the changelog script for this specific chart
            ./scripts/generate-changelog.sh \
              --chart "$CHART_NAME" \
              --pr-title "${PR_TITLE}" \
              --pr-number "${PR_NUMBER}" \
              --pr-url "${PR_URL}"
          done

          # Check if there are changes
          if git status --porcelain | grep -q 'CHANGELOG.md'; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changelog changes detected"
            git status --porcelain | grep 'CHANGELOG.md'
          else
            echo "‚ÑπÔ∏è  No CHANGELOG changes"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: üîÑ Update appVersion in Chart.yaml files
        if: steps.generate-changelog.outputs.has_changes == 'true' && env.clean_start_completed != 'true'
        run: ./scripts/update-appversion.sh --all

      - name: üíæ Commit and push changelog and chart updates
        if: steps.generate-changelog.outputs.has_changes == 'true' && env.clean_start_completed != 'true'
        run: |
          git add charts/*/CHANGELOG.md charts/*/Chart.yaml
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            COMMIT_MSG="chore: update CHANGELOG.md via manual trigger"
            if [ "${{ github.event.inputs.update_all_charts }}" = "true" ]; then
              COMMIT_MSG="chore: update CHANGELOG.md for all charts via manual trigger"
            fi
            if [ "${{ github.event.inputs.clean_start }}" = "true" ]; then
              COMMIT_MSG="chore: regenerate CHANGELOG.md with clean start"
            fi
          else
            COMMIT_MSG="chore: update CHANGELOG.md for merged changes"
          fi
          
          git commit -m "$COMMIT_MSG" \
            -m "Signed-off-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          # Pull latest changes and rebase our commit on top
          git pull --rebase origin main

          # Push the changes
          git push origin main
          
          echo "‚úÖ Changes pushed successfully"

      - name: üìä Generate job summary
        if: always()
        run: |
          echo "## üìù Changelog Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.charts-to-update.outputs.changed }}" != "true" ]; then
            echo "‚ÑπÔ∏è  No charts required changelog updates." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Update Mode:** ${{ steps.charts-to-update.outputs.update_mode }}" >> $GITHUB_STEP_SUMMARY
            echo "**Charts:** \`${{ steps.charts-to-update.outputs.changedCharts }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.generate-changelog.outputs.has_changes }}" = "true" ]; then
              echo "**Status:** ‚úÖ Changelogs updated and committed" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Status:** ‚ÑπÔ∏è  No changelog changes detected" >> $GITHUB_STEP_SUMMARY
            fi
          fi
