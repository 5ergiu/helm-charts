name: ğŸ§ª Pull Request Validation

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  detect-image-changes:
    name: ğŸ” Detect Image Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      changed_images: ${{ steps.detect.outputs.changed_images }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: ğŸ” Detect changed images
        id: detect
        run: |
          # Get changed files in examples/ directory
          all_changed=$(git diff --name-only \
            "${{ github.event.pull_request.base.sha }}" \
            "${{ github.event.pull_request.head.sha }}" \
            -- examples/ || true)

          # Exclude files that don't require image rebuilds:
          # - Helm values files (values*.yaml)
          # - Secrets files (secrets*.yaml, secrets*.yaml.example)
          # - Documentation (README.md, *.md)
          # Only build images if source files changed (Dockerfile, package.json, composer.json, etc.)
          changed_files=$(echo "$all_changed" | grep -vE '(values.*\.yaml|secrets.*\.yaml.*|README\.md|.*\.md)$' || true)

          if [ -z "$changed_files" ]; then
            echo "changed_images=" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No image-related changes detected in examples/ directory"
            if [ -n "$all_changed" ]; then
              echo "   (Only Helm values/secrets files changed - no rebuild needed)"
            fi
          else
            echo "ğŸ“ Changed files requiring image rebuild:"
            echo "$changed_files"
            echo ""

            # Extract unique app names from changed paths
            changed_apps=$(echo "$changed_files" | cut -d'/' -f2 | sort -u)

            # Convert to comma-separated list
            apps_list=$(echo "$changed_apps" | tr '\n' ',' | sed 's/,$//')

            echo "changed_images=$apps_list" >> $GITHUB_OUTPUT
            echo "âœ… Changed images detected: $apps_list"
          fi

  build-images:
    name: ğŸ—ï¸ Build Changed Images
    needs: detect-image-changes
    if: needs.detect-image-changes.outputs.changed_images != ''
    uses: ./.github/workflows/build-push-images.yaml
    with:
      apps: ${{ needs.detect-image-changes.outputs.changed_images }}
    permissions:
      contents: write
      packages: write

  resolve-charts:
    name: ğŸ“‹ Resolve Charts to Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      charts: ${{ steps.set-charts.outputs.charts }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: ğŸ”§ Set up chart-testing
        uses: helm/chart-testing-action@6ec842c01de15ebb84c8627d2744a0c2f2755c9f # v2.8.0

      - name: ğŸ” Find changed charts
        id: set-charts
        run: |
          changed=$(ct list-changed --target-branch ${{ github.event.repository.default_branch }})
          if [ -n "$changed" ]; then
            json=$(echo "$changed" | jq -R . | jq -s -c .)
            echo "charts=$json" >> $GITHUB_OUTPUT
            echo "Detected changed charts: $json"
          else
            # No changes detected - return empty array
            echo "No changes detected, returning empty array"
            echo "charts=[]" >> $GITHUB_OUTPUT
          fi

  test:
    name: ğŸ§ª Test Charts
    needs:
      - build-images
      - resolve-charts
    if: |
      needs.build-images.result != 'failure' &&
      needs.resolve-charts.outputs.charts != '[]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CI: true
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: âˆ Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: v4.0.1

      - name: ğŸ”§ Set up chart-testing
        uses: helm/chart-testing-action@6ec842c01de15ebb84c8627d2744a0c2f2755c9f # v2.8.0

      - name: ğŸ³ Set up kind
        uses: helm/kind-action@92086f6be054225fa813e0a4b13787fc9088faab # v1.13.0

      - name: ğŸ§ª Run tests
        env:
          LARAVEL_DATABASE_URL: ${{ secrets.LARAVEL_DATABASE_URL }}
          LARAVEL_REDIS_URL: ${{ secrets.LARAVEL_REDIS_URL }}
        run: ./scripts/test.sh

