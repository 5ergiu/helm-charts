name: ğŸ§ª Test Charts

on:
  workflow_call:
    inputs:
      chart:
        description: 'Specific chart to test (e.g., charts/laravel)'
        required: false
        type: string
    outputs:
      charts:
        description: "JSON array of changed charts"
        value: ${{ jobs.detect-charts.outputs.charts }}

jobs:
  detect-charts:
    name: ğŸ” Detect Changed Charts
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.set-charts.outputs.charts }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: ğŸ”§ Set up chart-testing
        uses: helm/chart-testing-action@6ec842c01de15ebb84c8627d2744a0c2f2755c9f # v2.8.0

      - name: ğŸ” Get changed charts
        id: set-charts
        run: |
          if [ -n "${{ inputs.chart }}" ]; then
            # Specific chart provided via input
            echo "Using specified chart: ${{ inputs.chart }}"
            json=$(echo '["${{ inputs.chart }}"]' | jq -c .)
            echo "charts=$json" >> $GITHUB_OUTPUT
          else
            # Auto-detect changed charts
            changed=$(ct list-changed --target-branch ${{ github.event.repository.default_branch }})
            if [ -n "$changed" ]; then
              json=$(echo "$changed" | jq -R . | jq -s -c .)
              echo "charts=$json" >> $GITHUB_OUTPUT
              echo "Detected changed charts: $json"
            else
              # If no changes detected (e.g., manual run from main), test all charts
              echo "No changes detected, finding all charts..."
              all_charts=$(for dir in charts/*/; do echo "${dir%/}"; done | jq -R . | jq -s -c .)
              echo "charts=$all_charts" >> $GITHUB_OUTPUT
              echo "Testing all charts: $all_charts"
            fi
          fi

  lint:
    name: ğŸ“Š Lint Charts
    needs: detect-charts
    if: needs.detect-charts.outputs.charts != '[]'
    strategy:
      matrix:
        chart: ${{ fromJSON(needs.detect-charts.outputs.charts) }}
    uses: ./.github/workflows/lint-chart.yaml
    with:
      chart: ${{ matrix.chart }}

  unittest:
    name: ğŸ§ª Unit Test Charts
    needs: detect-charts
    if: needs.detect-charts.outputs.charts != '[]'
    strategy:
      matrix:
        chart: ${{ fromJSON(needs.detect-charts.outputs.charts) }}
    uses: ./.github/workflows/unit-test-chart.yaml
    with:
      chart: ${{ matrix.chart }}

  integration-test:
    name: ğŸ§© Integration Test
    needs:
      - detect-charts
      - lint
      - unittest
    if: needs.detect-charts.outputs.charts != '[]'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: âˆ Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: v4.0.1

      - name: ğŸ”§ Set up chart-testing
        uses: helm/chart-testing-action@6ec842c01de15ebb84c8627d2744a0c2f2755c9f # v2.8.0

      - name: ğŸ³ Create kind cluster
        uses: helm/kind-action@92086f6be054225fa813e0a4b13787fc9088faab # v1.13.0
        with:
          cluster_name: helm-chart-test
          wait: 300s

      - name: ğŸ“¦ Install Traefik
        run: |
          echo "Adding Traefik Helm repository..."
          helm repo add traefik https://traefik.github.io/charts
          helm repo update

          echo "Installing Traefik with CRD provider enabled..."
          helm install traefik traefik/traefik \
            --namespace traefik \
            --create-namespace \
            --set providers.kubernetesCRD.enabled=true \
            --set providers.kubernetesIngress.enabled=true \
            --wait --timeout=5m

          echo "Verifying Traefik installation..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=traefik -n traefik --timeout=5m
          kubectl get pods -n traefik

          echo "Verifying CRDs are installed..."
          kubectl get crd | grep traefik
          echo "âœ… Traefik installed successfully with CRD support"

      - name: âœ… Install and test all changed charts
        run: |
          echo "Testing all changed charts in the cluster..."
          ct install --target-branch ${{ github.event.repository.default_branch }} --debug

      - name: ğŸ“Š Show cluster state
        run: |
          echo "=== All Resources ==="
          kubectl get all -A

          echo -e "\n=== Events ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -20
