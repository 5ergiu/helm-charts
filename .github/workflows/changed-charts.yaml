name: ðŸ” Changed Charts

on:
  workflow_call:
    outputs:
      charts:
        description: "JSON array of changed charts"
        value: ${{ jobs.changed-charts.outputs.charts }}

jobs:
  changed-charts:
    name: ðŸ” Find Changed Charts
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.set-charts.outputs.charts }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: ðŸ”§ Set up chart-testing
        uses: helm/chart-testing-action@6ec842c01de15ebb84c8627d2744a0c2f2755c9f # v2.8.0

      - name: ðŸ” Find changed charts
        id: set-charts
        run: |
          # Auto-detect changed charts
          changed=$(ct list-changed --target-branch ${{ github.event.repository.default_branch }})
          if [ -n "$changed" ]; then
            json=$(echo "$changed" | jq -R . | jq -s -c .)
            echo "charts=$json" >> $GITHUB_OUTPUT
            echo "Detected changed charts: $json"
          else
            # No changes detected - return empty array
            echo "No changes detected, returning empty array"
            echo "charts=[]" >> $GITHUB_OUTPUT
          fi
