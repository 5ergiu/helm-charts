name: ðŸ“Š Chart Metrics & Stats

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight

permissions:
  contents: write
  issues: write

jobs:
  metrics:
    name: Generate Metrics
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: âŽˆ Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: v4.0.1

      - name: ðŸ“Š Generate chart statistics
        id: stats
        run: |
          echo "## ðŸ“Š Helm Charts Repository Statistics" > metrics.md
          echo "" >> metrics.md
          echo "Generated on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> metrics.md
          echo "" >> metrics.md

          TOTAL_CHARTS=0
          TOTAL_TEMPLATES=0
          TOTAL_TESTS=0
          TOTAL_VALUES_LINES=0

          echo "### ðŸ“¦ Charts Overview" >> metrics.md
          echo "" >> metrics.md
          echo "| Chart | Version | Templates | Tests | Values Lines | Last Updated |" >> metrics.md
          echo "|-------|---------|-----------|-------|--------------|--------------|" >> metrics.md

          for chart_dir in charts/*/; do
            if [ ! -f "${chart_dir}Chart.yaml" ]; then
              continue
            fi

            CHART_NAME=$(basename "$chart_dir")
            TOTAL_CHARTS=$((TOTAL_CHARTS + 1))

            # Get chart version
            VERSION=$(yq eval '.version' "${chart_dir}Chart.yaml" 2>/dev/null || echo "N/A")

            # Count templates
            TEMPLATE_COUNT=$(find "${chart_dir}templates" -name "*.yaml" -o -name "*.tpl" 2>/dev/null | wc -l || echo 0)
            TOTAL_TEMPLATES=$((TOTAL_TEMPLATES + TEMPLATE_COUNT))

            # Count tests
            TEST_COUNT=$(find "${chart_dir}tests" -name "*_test.yaml" 2>/dev/null | wc -l || echo 0)
            TOTAL_TESTS=$((TOTAL_TESTS + TEST_COUNT))

            # Count values.yaml lines
            if [ -f "${chart_dir}values.yaml" ]; then
              VALUES_LINES=$(wc -l < "${chart_dir}values.yaml")
              TOTAL_VALUES_LINES=$((TOTAL_VALUES_LINES + VALUES_LINES))
            else
              VALUES_LINES=0
            fi

            # Get last commit date for chart
            LAST_UPDATED=$(git log -1 --format=%cd --date=short -- "$chart_dir" 2>/dev/null || echo "N/A")

            echo "| $CHART_NAME | $VERSION | $TEMPLATE_COUNT | $TEST_COUNT | $VALUES_LINES | $LAST_UPDATED |" >> metrics.md
          done

          echo "" >> metrics.md
          echo "### ðŸ“ˆ Repository Totals" >> metrics.md
          echo "" >> metrics.md
          echo "- **Total Charts:** $TOTAL_CHARTS" >> metrics.md
          echo "- **Total Templates:** $TOTAL_TEMPLATES" >> metrics.md
          echo "- **Total Tests:** $TOTAL_TESTS" >> metrics.md
          echo "- **Total Values Configuration Lines:** $TOTAL_VALUES_LINES" >> metrics.md
          echo "" >> metrics.md

          # Git statistics
          echo "### ðŸ“œ Git Statistics" >> metrics.md
          echo "" >> metrics.md
          TOTAL_COMMITS=$(git rev-list --count HEAD)
          CONTRIBUTORS=$(git log --format='%aN' | sort -u | wc -l)
          FIRST_COMMIT=$(git log --reverse --format=%cd --date=short | head -1)
          
          echo "- **Total Commits:** $TOTAL_COMMITS" >> metrics.md
          echo "- **Contributors:** $CONTRIBUTORS" >> metrics.md
          echo "- **Repository Age:** Since $FIRST_COMMIT" >> metrics.md
          echo "" >> metrics.md

          # Recent releases
          echo "### ðŸ·ï¸ Recent Releases" >> metrics.md
          echo "" >> metrics.md
          git tag -l --sort=-creatordate | head -10 | while read tag; do
            TAG_DATE=$(git log -1 --format=%cd --date=short "$tag" 2>/dev/null)
            echo "- \`$tag\` - $TAG_DATE" >> metrics.md
          done

          # Save to output
          cat metrics.md >> $GITHUB_STEP_SUMMARY
          
          echo "total_charts=$TOTAL_CHARTS" >> $GITHUB_OUTPUT
          echo "total_templates=$TOTAL_TEMPLATES" >> $GITHUB_OUTPUT
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
