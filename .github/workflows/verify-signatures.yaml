name: üîè Verify Signatures

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  check-signed-commits:
    name: Verify Commit Signatures
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: üîç Check commit signatures
        id: check-signatures
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            let totalCommits = 0;
            let signedCommits = 0;
            let unsignedCommits = [];

            for (const commit of commits) {
              totalCommits++;
              const sha = commit.sha;

              // Get commit details to check verification
              const { data: commitData } = await github.rest.repos.getCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: sha,
              });

              if (commitData.commit.verification && commitData.commit.verification.verified) {
                signedCommits++;
                console.log(`‚úì Verified: ${sha.substring(0, 7)} - ${commit.commit.message.split('\n')[0]}`);
              } else {
                unsignedCommits.push(sha);
                console.log(`‚úó Unverified: ${sha.substring(0, 7)} - ${commit.commit.message.split('\n')[0]}`);
              }
            }

            const status = signedCommits === totalCommits ? 'success' : 'warning';

            core.setOutput('total_commits', totalCommits);
            core.setOutput('signed_commits', signedCommits);
            core.setOutput('unsigned_commits', unsignedCommits.join(' '));
            core.setOutput('status', status);

            return {
              totalCommits,
              signedCommits,
              unsignedCommits,
              status
            };

      - name: Comment on PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const totalCommits = parseInt('${{ steps.check-signatures.outputs.total_commits }}');
            const signedCommits = parseInt('${{ steps.check-signatures.outputs.signed_commits }}');
            const unsignedCommits = '${{ steps.check-signatures.outputs.unsigned_commits }}'.trim();
            const status = '${{ steps.check-signatures.outputs.status }}';
            
            let body = '## üîê Commit Signature Check\n\n';
            
            if (status !== 'success') {
              body += `‚ö†Ô∏è  Some commits are not signed (${signedCommits}/${totalCommits} signed)\n\n`;
              body += '### Unsigned Commits\n';
              body += unsignedCommits.split(' ').filter(c => c).map(c => `- \`${c.substring(0, 7)}\``).join('\n');
              body += '\n\n### How to Sign Commits\n\n';
              body += '**Using SSH (Recommended)**\n';
              body += '```bash\n';
              body += 'git config gpg.format ssh\n';
              body += 'git config user.signingkey ~/.ssh/id_ed25519.pub\n';
              body += 'git config commit.gpgsign true\n';
              body += '```\n\n';
              body += '**Using GPG**\n';
              body += '```bash\n';
              body += 'git config user.signingkey YOUR_GPG_KEY_ID\n';
              body += 'git config commit.gpgsign true\n';
              body += '```\n\n';
              body += '**Sign Existing Commits**\n';
              body += '```bash\n';
              body += '# Rebase and sign\n';
              body += 'git rebase --exec "git commit --amend --no-edit -S" -i origin/main\n';
              body += 'git push --force-with-lease\n';
              body += '```\n\n';
              body += 'Learn more: [GitHub Docs on Commit Signing](https://docs.github.com/en/authentication/managing-commit-signature-verification)';

              // Find existing comment
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const botComment = comments.data.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('üîê Commit Signature Check')
              );
              
              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
            }
